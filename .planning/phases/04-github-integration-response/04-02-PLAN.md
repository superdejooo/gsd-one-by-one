---
phase: 04-github-integration-response
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/git/git.js
  - src/git/branches.js
  - package.json
autonomous: true

must_haves:
  truths:
    - "Action can create milestone branches with naming pattern gsd/{milestone-number}"
    - "Action can create phase branches with naming pattern gsd/{milestone}-{phase}-{slugified-phase-name}"
    - "Action can execute git commands asynchronously with proper error handling"
    - "Branch creation handles existing branches gracefully"
  artifacts:
    - path: "src/git/git.js"
      provides: "Git command execution with promises and error handling"
      exports: ["runGitCommand", "createAndSwitchBranch", "switchBranch"]
      min_lines: 50
    - path: "src/git/branches.js"
      provides: "Branch management with naming conventions"
      exports: ["createMilestoneBranch", "createPhaseBranch", "slugify"]
      min_lines: 60
  key_links:
    - from: "src/git/git.js"
      to: "child_process.exec"
      via: "util.promisify wrapper"
      pattern: "promisify\\(exec\\)"
    - from: "src/git/branches.js"
      to: "src/git/git.js"
      via: "createAndSwitchBranch import"
      pattern: "import.*createAndSwitchBranch.*from.*git"
    - from: "src/git/branches.js"
      to: "slugify function"
      via: "phase name transformation"
      pattern: "slugify\\(phaseName\\)"
---

<objective>
Implement git operations for branch creation and management with support for milestone and phase branch naming conventions.

Purpose: Enable the bot to create structured branches following the gsd/{milestone} and gsd/{milestone}-{phase}-{slug} patterns. This establishes the git workflow layer that Phase 5 (Milestone Creation) will use to organize planning work.

Output: Complete git operations module with async command execution, branch creation functions, and automatic phase name slugification.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-github-integration-response/04-CONTEXT.md
@.planning/phases/04-github-integration-response/04-RESEARCH.md

# Current codebase structure
@src/index.js
@src/lib/parser.js
@src/lib/config.js
@src/lib/validator.js
@package.json

# Previous phase summary for context
@.planning/phases/03-ccr-integration/03-04-SUMMARY.md

# Plan 01 from this phase (parallel execution - no dependency)
@.planning/phases/04-github-integration-response/04-01-PLAN.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create git command execution module</name>
  <files>
    src/git/git.js
  </files>
  <action>
    Create src/git/git.js implementing:
    - Import promisify from node:util and exec from node:child_process
    - Import @actions/core for logging
    - Create execAsync = promisify(exec) for promise-based execution

    - Export runGitCommand(command) function:
      * Log command with core.debug
      * Execute via execAsync with try/catch
      * Log stderr as warning if present (git outputs info to stderr)
      * Return stdout.trim()
      * On error: log command, exit code, and error message with core.error, then throw

    - Export createAndSwitchBranch(branchName, startPoint = null) function:
      * Construct command: `git switch -c ${branchName}` (optionally add startPoint)
      * Call runGitCommand with constructed command
      * Log success with core.info

    - Export switchBranch(branchName) function:
      * Construct command: `git switch ${branchName}`
      * Call runGitCommand
      * Log success with core.info

    Reference Pattern 3 and Pattern 4 from 04-RESEARCH.md for git command execution and branch operations.

    **Critical implementation details:**
    - Use modern `git switch` (not `git checkout`) per Git 2.23+ best practices
    - Always check stderr and log as warnings (git uses stderr for non-error output)
    - Include exit code in error logging for debugging
    - Use node:util and node:child_process imports (Node.js built-ins, no external deps)
  </action>
  <verify>
    ```bash
    # Verify module created and exports
    test -f src/git/git.js
    grep -E "export.*runGitCommand|export.*createAndSwitchBranch|export.*switchBranch" src/git/git.js

    # Verify imports
    grep "import.*promisify.*from.*node:util" src/git/git.js
    grep "import.*exec.*from.*node:child_process" src/git/git.js
    grep "import.*core.*from.*@actions/core" src/git/git.js

    # Verify git switch usage (not checkout)
    grep "git switch" src/git/git.js
    ! grep "git checkout" src/git/git.js && echo "✓ No git checkout (using modern git switch)"

    # Verify error handling
    grep "try {" src/git/git.js
    grep "catch.*error" src/git/git.js
    grep "core.error" src/git/git.js
    ```
  </verify>
  <done>
    - src/git/git.js exists with runGitCommand, createAndSwitchBranch, and switchBranch exports
    - Uses promisify(exec) for async git command execution
    - Uses modern git switch (not checkout) for branch operations
    - Comprehensive error handling with exit code and error message logging
    - stderr logged as warnings (git normal behavior)
  </done>
</task>

<task type="auto">
  <name>Task 2: Create branch management module with naming conventions</name>
  <files>
    src/git/branches.js
  </files>
  <action>
    Create src/git/branches.js implementing:
    - Import createAndSwitchBranch and switchBranch from ./git.js
    - Import @actions/core for logging

    - Export slugify(text) function:
      * Convert to lowercase
      * Replace non-alphanumeric characters with hyphens
      * Remove leading/trailing hyphens
      * Limit to 50 characters
      * Return slugified string

    - Export createMilestoneBranch(milestoneNumber) function:
      * Construct branchName: `gsd/${milestoneNumber}`
      * Call createAndSwitchBranch(branchName)
      * Log milestone branch creation with core.info

    - Export createPhaseBranch(milestoneNumber, phaseNumber, phaseName, startPoint = null) function:
      * Slugify phaseName using slugify function
      * Construct branchName: `gsd/${milestoneNumber}-${phaseNumber}-${slug}`
      * Call createAndSwitchBranch(branchName, startPoint)
      * Log phase branch creation with core.info including original and slugified names

    Reference Pattern 4 and "Branch Naming Convention" section from 04-RESEARCH.md for branch naming patterns.

    **Branch naming from 04-CONTEXT.md:**
    - Milestone branches: `gsd/1`, `gsd/2` (minimal format)
    - Phase branches: `gsd/1-1-basic-user-auth` (flat structure: milestone-phase-slug)
    - Example: `gsd/1-2-session-management`

    **Critical implementation details:**
    - slugify must handle special characters, spaces, and Unicode safely
    - Branch names must be valid git refs (no spaces, special chars, control chars)
    - startPoint parameter allows creating from specific branch/commit
    - All branch operations use the imported git.js functions (no direct git commands)
  </action>
  <verify>
    ```bash
    # Verify module created and exports
    test -f src/git/branches.js
    grep -E "export.*createMilestoneBranch|export.*createPhaseBranch|export.*slugify" src/git/branches.js

    # Verify imports from git.js
    grep "import.*createAndSwitchBranch.*from.*./git" src/git/branches.js

    # Verify branch naming patterns
    grep "gsd/\${milestoneNumber}" src/git/branches.js
    grep "gsd/\${milestoneNumber}-\${phaseNumber}" src/git/branches.js

    # Verify slugify implementation
    grep "toLowerCase()" src/git/branches.js
    grep "replace.*[^a-z0-9]" src/git/branches.js
    grep "substring.*50" src/git/branches.js
    ```
  </verify>
  <done>
    - src/git/branches.js exists with createMilestoneBranch, createPhaseBranch, and slugify exports
    - Branch naming follows 04-CONTEXT.md patterns (gsd/{milestone}, gsd/{milestone}-{phase}-{slug})
    - slugify function handles special characters and limits length to 50
    - All operations use git.js functions (no direct command execution)
    - Logging includes both original and slugified phase names
  </done>
</task>

<task type="auto">
  <name>Task 3: Rebuild bundle with git operations</name>
  <files>
    dist/index.js
    dist/licenses.txt
  </files>
  <action>
    Rebuild the action bundle to include git operation modules:
    ```bash
    npm run build
    ```

    Verify bundle includes:
    - src/git/git.js functions (runGitCommand, createAndSwitchBranch, switchBranch)
    - src/git/branches.js functions (createMilestoneBranch, createPhaseBranch, slugify)

    No new dependencies added (using Node.js built-ins: util.promisify, child_process.exec).

    Check bundle size remains reasonable (should be similar to Phase 4 Plan 1 size ~33k-35k lines).
  </action>
  <verify>
    ```bash
    # Verify bundle rebuilt
    test -f dist/index.js
    test -f dist/licenses.txt

    # Verify git functions bundled
    grep -q "runGitCommand" dist/index.js && echo "✓ runGitCommand bundled"
    grep -q "createMilestoneBranch" dist/index.js && echo "✓ createMilestoneBranch bundled"
    grep -q "createPhaseBranch" dist/index.js && echo "✓ createPhaseBranch bundled"
    grep -q "slugify" dist/index.js && echo "✓ slugify bundled"

    # Verify git switch usage (not checkout)
    grep -q "git switch" dist/index.js && echo "✓ Uses git switch"

    # Check bundle size
    wc -l dist/index.js
    ```
  </verify>
  <done>
    - dist/index.js rebuilt with git operation modules
    - All git functions present in bundle (verified with grep)
    - Bundle uses modern git switch (not checkout)
    - Bundle size verified (expected ~33k-35k lines, no new external deps)
    - No build errors or warnings
  </done>
</task>

</tasks>

<verification>
Run verification checks:

```bash
# 1. Verify all files exist
test -f src/git/git.js && echo "✓ git.js exists"
test -f src/git/branches.js && echo "✓ branches.js exists"

# 2. Verify exports work
node --input-type=module -e "import {runGitCommand, createAndSwitchBranch, switchBranch} from './src/git/git.js'; console.log('✓ git.js exports valid')"
node --input-type=module -e "import {createMilestoneBranch, createPhaseBranch, slugify} from './src/git/branches.js'; console.log('✓ branches.js exports valid')"

# 3. Test slugify function behavior
node --input-type=module -e "import {slugify} from './src/git/branches.js'; console.log('Test:', slugify('Basic User Auth')); console.log('✓ slugify works')"

# 4. Verify bundle includes new code
grep -c "runGitCommand" dist/index.js
grep -c "createMilestoneBranch" dist/index.js
grep -c "git switch" dist/index.js

# 5. Verify no git checkout in code
! grep "git checkout" src/git/*.js && echo "✓ No git checkout (modern git switch only)"
```

Expected outcomes:
- All test files exist
- Both modules export successfully
- slugify function executes and transforms text
- Bundle contains all new functions
- No legacy git checkout commands
</verification>

<success_criteria>
Phase 4 Plan 2 is complete when:

1. **Git Operations Module (src/git/git.js)**
   - runGitCommand() executes git commands via promisify(exec)
   - createAndSwitchBranch() creates and switches to new branch using git switch -c
   - switchBranch() switches to existing branch using git switch
   - Comprehensive error handling with exit code logging
   - stderr logged as warnings (git normal behavior)

2. **Branch Management Module (src/git/branches.js)**
   - createMilestoneBranch() creates branches with pattern gsd/{milestone-number}
   - createPhaseBranch() creates branches with pattern gsd/{milestone}-{phase}-{slug}
   - slugify() transforms phase names to URL-safe slugs (lowercase, hyphens, 50 char limit)
   - All branch operations use git.js functions (no direct command execution)
   - Logging includes original and slugified phase names

3. **Branch Naming Compliance**
   - Milestone branches: gsd/1, gsd/2, etc. (flat structure)
   - Phase branches: gsd/1-1-basic-user-auth (milestone-phase-slug, flat structure)
   - Follows 04-CONTEXT.md naming patterns exactly
   - No nested directory structure (all branches at root level)

4. **Modern Git Commands**
   - Uses git switch (not git checkout) per Git 2.23+ best practices
   - No legacy git checkout commands anywhere in code
   - Consistent with current Git recommendations

5. **Bundle Integrity**
   - dist/index.js rebuilt and contains all git functions
   - Bundle size reasonable (~33k-35k lines, no new deps)
   - No bundling errors
   - No external dependencies added (uses Node.js built-ins)

6. **Verification Passing**
   - All manual verification checks pass
   - Module imports work correctly
   - slugify function produces expected output
   - Bundle grep checks find expected functions
</success_criteria>

<output>
After completion, create `.planning/phases/04-github-integration-response/04-02-SUMMARY.md`

Summary should document:
- Git operations module structure and async execution pattern
- Branch naming conventions and slugification logic
- Modern git switch usage vs legacy git checkout
- Bundle metrics (size, no new deps)
- Key decisions (error handling, stderr warnings)
- Files created and their purposes
</output>
