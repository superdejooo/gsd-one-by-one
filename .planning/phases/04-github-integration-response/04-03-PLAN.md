---
phase: 04-github-integration-response
plan: 03
type: execute
wave: 2
depends_on: [04-01, 04-02]
files_modified:
  - src/git/git.js
  - src/errors/handler.js
  - src/index.js
autonomous: true

must_haves:
  truths:
    - "Action configures git user identity before making commits"
    - "Action catches all errors and posts structured error comments to GitHub"
    - "Action includes workflow run URLs in all error comments"
    - "Main action entry integrates error handling wrapper"
  artifacts:
    - path: "src/git/git.js"
      provides: "Git identity configuration function"
      exports: ["configureGitIdentity"]
      min_lines: 60
    - path: "src/errors/handler.js"
      provides: "Centralized error handling with GitHub comment posting"
      exports: ["withErrorHandling"]
      min_lines: 40
    - path: "src/index.js"
      provides: "Main action entry with error handling integration"
      contains: "withErrorHandling"
  key_links:
    - from: "src/git/git.js"
      to: "git config set"
      via: "configureGitIdentity function"
      pattern: "git config set user\\.(name|email)"
    - from: "src/errors/handler.js"
      to: "src/lib/github.js"
      via: "postComment and getWorkflowRunUrl imports"
      pattern: "import.*\\{.*postComment.*getWorkflowRunUrl.*\\}.*from.*github"
    - from: "src/errors/handler.js"
      to: "src/errors/formatter.js"
      via: "formatErrorComment import"
      pattern: "import.*formatErrorComment.*from.*formatter"
    - from: "src/index.js"
      to: "src/errors/handler.js"
      via: "withErrorHandling wrapper"
      pattern: "withErrorHandling\\("
---

<objective>
Implement git configuration for automated commits and centralized error handling with GitHub comment posting.

Purpose: Complete the GitHub integration layer by ensuring git commits can succeed with proper identity configuration and all errors are caught and communicated to users via structured GitHub comments with workflow run URLs. This finalizes the Phase 4 infrastructure needed for Phase 5 (Milestone Creation).

Output: Git identity configuration function, centralized error handler with automatic GitHub comment posting, and main action entry integration for production-ready error handling.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-github-integration-response/04-CONTEXT.md
@.planning/phases/04-github-integration-response/04-RESEARCH.md

# Current codebase structure

@src/index.js
@src/lib/parser.js
@src/lib/config.js
@src/lib/validator.js
@package.json

# Previous phase summary for context

@.planning/phases/03-ccr-integration/03-04-SUMMARY.md

# Plans 01 and 02 from this phase (dependencies)

@.planning/phases/04-github-integration-response/04-01-PLAN.md
@.planning/phases/04-github-integration-response/04-02-PLAN.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add git identity configuration to git operations module</name>
  <files>
    src/git/git.js
  </files>
  <action>
    Extend src/git/git.js (created in 04-02) with git identity configuration:

    - Export configureGitIdentity(name, email) function:
      * Use runGitCommand to execute `git config set user.name "${name}"`
      * Use runGitCommand to execute `git config set user.email "${email}"`
      * Log success with core.info: "Git identity configured: {name} <{email}>"
      * This sets local repository config (default scope) - does not affect global git config

    Reference Pattern 5 from 04-RESEARCH.md for git identity configuration.

    **Git identity from 04-RESEARCH.md:**
    - Standard GitHub Actions bot: `github-actions[bot]` with email `41898282+github-actions[bot]@users.noreply.github.com`
    - Alternative: Custom bot identity (Claude's Discretion per 04-CONTEXT.md)
    - Recommendation: Use github-actions[bot] for transparency

    **Critical implementation details:**
    - Use `git config set` (not `git config --add` or older syntax) per modern Git
    - Default scope is --local (repository-specific) - no need to specify flag
    - Always configure BEFORE any git commits (git will fail without identity)
    - Use double quotes around name/email to handle spaces safely

  </action>
  <verify>
    ```bash
    # Verify function added
    grep -E "export.*configureGitIdentity" src/git/git.js

    # Verify git config set usage
    grep "git config set user.name" src/git/git.js
    grep "git config set user.email" src/git/git.js

    # Verify uses runGitCommand (no direct exec)
    grep -A3 "configureGitIdentity" src/git/git.js | grep "runGitCommand"

    # Verify logging
    grep "Git identity configured" src/git/git.js
    ```

  </verify>
  <done>
    - configureGitIdentity function added to src/git/git.js
    - Uses runGitCommand for both user.name and user.email
    - Sets local repository config (not global)
    - Logs configured identity for debugging
    - Uses modern git config set syntax
  </done>
</task>

<task type="auto">
  <name>Task 2: Create centralized error handler with GitHub comment posting</name>
  <files>
    src/errors/handler.js
  </files>
  <action>
    Create src/errors/handler.js implementing:
    - Import @actions/core for setFailed
    - Import formatErrorComment from ./formatter.js
    - Import postComment and getWorkflowRunUrl from ../lib/github.js

    - Export withErrorHandling(operation, context) async function:
      * Get workflow URL via getWorkflowRunUrl()
      * Try executing operation() (async function)
      * On success: return {success: true, ...result}
      * On error:
        - Call core.setFailed(error.message) to mark action as failed
        - If context.issueNumber exists:
          * Format error with formatErrorComment(error, workflowUrl)
          * Post comment via postComment(context.owner, context.repo, context.issueNumber, errorComment)
        - Return {success: false, error: error.message}

    Reference "Centralized Error Handler with Retry" section from 04-RESEARCH.md.

    **Error handling requirements from 04-CONTEXT.md and ROADMAP:**
    - ERR-01: Post structured error messages to issue comments
    - ERR-02: Include workflow run URL in error comments for debugging
    - ERR-05: Catch and report all errors without crashing workflow
    - Always suggest next steps (handled by formatErrorComment from Plan 01)

    **Critical implementation details:**
    - withErrorHandling is a higher-order function (takes operation function)
    - context object must include: owner, repo, issueNumber (optional)
    - If issueNumber missing, only log error (no comment post)
    - Always call core.setFailed to mark workflow as failed
    - Return consistent shape: {success: boolean, error?: string, ...result}

  </action>
  <verify>
    ```bash
    # Verify module created and exports
    test -f src/errors/handler.js
    grep -E "export.*withErrorHandling" src/errors/handler.js

    # Verify imports
    grep "import.*core.*from.*@actions/core" src/errors/handler.js
    grep "import.*formatErrorComment.*from.*./formatter" src/errors/handler.js
    grep "import.*postComment.*getWorkflowRunUrl.*from.*../lib/github" src/errors/handler.js

    # Verify error handling structure
    grep "try {" src/errors/handler.js
    grep "catch.*error" src/errors/handler.js
    grep "core.setFailed" src/errors/handler.js
    grep "postComment" src/errors/handler.js
    ```

  </verify>
  <done>
    - src/errors/handler.js exists with withErrorHandling export
    - Wraps async operations with try/catch
    - Posts formatted error comments to GitHub issues/PRs on failure
    - Includes workflow run URLs in all error comments
    - Marks action as failed via core.setFailed
    - Returns consistent result shape for both success and error cases
  </done>
</task>

<task type="auto">
  <name>Task 3: Integrate error handler into main action entry and rebuild bundle</name>
  <files>
    src/index.js
    dist/index.js
    dist/licenses.txt
  </files>
  <action>
    Integrate error handling into src/index.js:

    1. **Add imports:**
       - Import withErrorHandling from ./errors/handler.js
       - Keep existing imports (github, core, parser, config, validator)

    2. **Wrap main logic with error handler:**
       - Identify main execution block in src/index.js
       - Extract github context (owner, repo, issueNumber) from github.context
       - Wrap command execution in withErrorHandling:
         ```javascript
         const result = await withErrorHandling(async () => {
           // Existing command execution logic here
           return { /* result */ };
         }, {
           owner: github.context.repo.owner,
           repo: github.context.repo.repo,
           issueNumber: github.context.issue.number
         });
         ```

    3. **Handle result:**
       - If result.success === false, exit gracefully (error already posted)
       - If result.success === true, continue normal flow

    **Note:** Do NOT modify command parsing/validation logic - only wrap execution in error handler.

    4. **Rebuild bundle:**
       ```bash
       npm run build
       ```

    Verify bundle includes:
    - src/errors/handler.js (withErrorHandling)
    - src/git/git.js (configureGitIdentity)
    - All functions from Plans 01 and 02

    Reference "Complete GitHub API Operations Module" and error handling patterns from 04-RESEARCH.md.

    **Critical implementation details:**
    - Extract context properties early (owner, repo, issueNumber)
    - Operation function must be async and return result
    - Error handler is invoked for ALL uncaught errors in operation
    - Bundle should remain ~33k-35k lines (minimal additions)

  </action>
  <verify>
    ```bash
    # Verify index.js updated
    grep "import.*withErrorHandling" src/index.js
    grep "withErrorHandling(" src/index.js

    # Verify bundle rebuilt
    test -f dist/index.js
    test -f dist/licenses.txt

    # Verify all Phase 4 functions bundled
    grep -q "withErrorHandling" dist/index.js && echo "✓ withErrorHandling bundled"
    grep -q "configureGitIdentity" dist/index.js && echo "✓ configureGitIdentity bundled"
    grep -q "postComment" dist/index.js && echo "✓ postComment bundled"
    grep -q "formatErrorComment" dist/index.js && echo "✓ formatErrorComment bundled"

    # Check bundle size
    wc -l dist/index.js
    ```

  </verify>
  <done>
    - src/index.js imports and uses withErrorHandling wrapper
    - Main action execution wrapped with error handler
    - Context (owner, repo, issueNumber) extracted for error posting
    - dist/index.js rebuilt with all Phase 4 modules
    - All verification checks pass (all functions present in bundle)
    - Bundle size verified (expected ~33k-35k lines)
    - No build errors or warnings
  </done>
</task>

</tasks>

<verification>
Run verification checks:

```bash
# 1. Verify all files exist and updated
test -f src/git/git.js && echo "✓ git.js exists"
test -f src/errors/handler.js && echo "✓ handler.js exists"
grep -q "configureGitIdentity" src/git/git.js && echo "✓ configureGitIdentity added"
grep -q "withErrorHandling" src/index.js && echo "✓ index.js integrated"

# 2. Verify exports work
node --input-type=module -e "import {configureGitIdentity} from './src/git/git.js'; console.log('✓ configureGitIdentity exports')"
node --input-type=module -e "import {withErrorHandling} from './src/errors/handler.js'; console.log('✓ withErrorHandling exports')"

# 3. Verify error handler integration
grep -A10 "withErrorHandling" src/index.js | grep -q "owner" && echo "✓ Context extracted"
grep -A10 "withErrorHandling" src/index.js | grep -q "issueNumber" && echo "✓ Issue number passed"

# 4. Verify bundle completeness (all Phase 4 functions)
for func in "postComment" "formatErrorComment" "formatSuccessComment" "getWorkflowRunUrl" "runGitCommand" "createMilestoneBranch" "createPhaseBranch" "configureGitIdentity" "withErrorHandling"; do
  grep -q "$func" dist/index.js && echo "✓ $func bundled" || echo "✗ $func MISSING"
done

# 5. Verify git config syntax (modern)
grep -q "git config set" src/git/git.js && echo "✓ Modern git config syntax"

# 6. Check final bundle size
wc -l dist/index.js
ls -lh dist/index.js
```

Expected outcomes:

- All files exist and updated
- All modules export successfully
- Error handler integrated in index.js with context
- Bundle contains all 9 Phase 4 functions
- Modern git config set syntax used
- Bundle size reasonable (~33k-35k lines)
  </verification>

<success_criteria>
Phase 4 Plan 3 is complete when:

1. **Git Identity Configuration**
   - configureGitIdentity() added to src/git/git.js
   - Uses git config set for user.name and user.email
   - Sets local repository config (not global)
   - Logs configured identity for debugging
   - Uses modern git config syntax

2. **Centralized Error Handler (src/errors/handler.js)**
   - withErrorHandling() wraps async operations with try/catch
   - Posts formatted error comments to GitHub on failure
   - Includes workflow run URL in all error comments
   - Marks action as failed via core.setFailed
   - Returns consistent result shape: {success: boolean, error?: string, ...result}

3. **Main Action Integration (src/index.js)**
   - Imports withErrorHandling from ./errors/handler.js
   - Wraps main execution logic with error handler
   - Extracts context (owner, repo, issueNumber) from github.context
   - Passes context to error handler for comment posting
   - Handles both success and error result cases

4. **Requirements Coverage**
   - GITH-05: Git identity configured before commits ✓
   - ERR-01: Structured error messages posted to issues ✓
   - ERR-02: Workflow run URLs included in errors ✓
   - ERR-05: All errors caught and reported without crashing ✓

5. **Bundle Integrity**
   - dist/index.js rebuilt with all Phase 4 modules
   - All 9 Phase 4 functions present in bundle:
     - postComment, getWorkflowRunUrl
     - formatErrorComment, formatSuccessComment
     - runGitCommand, createAndSwitchBranch, switchBranch
     - createMilestoneBranch, createPhaseBranch
     - configureGitIdentity
     - withErrorHandling
   - Bundle size reasonable (~33k-35k lines)
   - No bundling errors

6. **Verification Passing**
   - All manual verification checks pass
   - Module imports work correctly
   - Error handler integration verified
   - All functions present in bundle
   - Modern git syntax verified
     </success_criteria>

<output>
After completion, create `.planning/phases/04-github-integration-response/04-03-SUMMARY.md`

Summary should document:

- Git identity configuration approach (github-actions[bot] vs custom)
- Error handling architecture (withErrorHandling wrapper pattern)
- Main action integration approach
- Bundle metrics and Phase 4 completion status
- Key decisions (local git config, error posting strategy)
- All Phase 4 capabilities delivered
- Requirements coverage (GITH-05, ERR-01, ERR-02, ERR-05)
- Readiness for Phase 5 (Milestone Creation Workflow)
  </output>
