---
phase: 04-github-integration-response
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/github.js
  - src/errors/formatter.js
  - package.json
autonomous: true

must_haves:
  truths:
    - "Action can post markdown-formatted comments to GitHub issues"
    - "Action handles GitHub API rate limits with automatic retry"
    - "Action posts structured error messages with workflow run URLs"
    - "Action formats success messages with rich markdown"
  artifacts:
    - path: "src/lib/github.js"
      provides: "GitHub API operations wrapper with throttling"
      exports: ["postComment", "getWorkflowRunUrl"]
      min_lines: 40
    - path: "src/errors/formatter.js"
      provides: "Error and success message formatting"
      exports: ["formatErrorComment", "formatSuccessComment"]
      min_lines: 50
    - path: "package.json"
      provides: "@octokit/plugin-throttling dependency"
      contains: "@octokit/plugin-throttling"
  key_links:
    - from: "src/lib/github.js"
      to: "@actions/github octokit"
      via: "octokit.rest.issues.createComment"
      pattern: "octokit\\.rest\\.issues\\.createComment"
    - from: "src/lib/github.js"
      to: "@octokit/plugin-throttling"
      via: "GitHub.plugin(throttling)"
      pattern: "GitHub\\.plugin\\(throttling\\)"
    - from: "src/errors/formatter.js"
      to: "src/lib/github.js"
      via: "getWorkflowRunUrl import"
      pattern: "import.*getWorkflowRunUrl.*from.*github"
---

<objective>
Implement GitHub API operations for posting comments to issues/PRs with rate limit handling and structured error formatting.

Purpose: Enable the bot to communicate with users via GitHub comments, posting both success messages and structured errors with workflow run URLs. This establishes the core communication layer between the action and GitHub users.

Output: Complete GitHub API integration module with throttled octokit client, comment posting functions, and rich markdown formatting utilities for errors and successes.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-github-integration-response/04-CONTEXT.md
@.planning/phases/04-github-integration-response/04-RESEARCH.md

# Current codebase structure
@src/index.js
@src/lib/parser.js
@src/lib/config.js
@src/lib/validator.js
@package.json

# Previous phase summary for context
@.planning/phases/03-ccr-integration/03-04-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install @octokit/plugin-throttling and create GitHub API module</name>
  <files>
    package.json
    src/lib/github.js
  </files>
  <action>
    Install @octokit/plugin-throttling dependency:
    ```bash
    npm install @octokit/plugin-throttling
    ```

    Create src/lib/github.js implementing:
    - Import @actions/github and @octokit/plugin-throttling
    - Initialize ThrottledOctokit with plugin configuration
    - Configure throttling with onRateLimit callback (retry once on primary limits)
    - Configure throttling with onSecondaryRateLimit callback (log warning, no retry)
    - Export postComment(owner, repo, issueNumber, body) function using octokit.rest.issues.createComment
    - Export getWorkflowRunUrl() function constructing URL from github.context (server_url, repository, run_id, run_attempt)
    - Use @actions/core for logging (core.info, core.warn)

    Reference Pattern 1 and Pattern 2 from 04-RESEARCH.md for octokit setup and comment posting.

    **Critical implementation details:**
    - Use github.GitHub.plugin(throttling) to create ThrottledOctokit class
    - Set retryCount < 1 in onRateLimit to retry once on rate limits
    - Include all four context properties in workflow URL: server_url, repository, run_id, run_attempt
    - Use octokit.rest.issues.createComment (works for both issues and PRs)
  </action>
  <verify>
    ```bash
    # Verify dependency installed
    grep "@octokit/plugin-throttling" package.json

    # Verify module exports
    grep -E "export.*postComment|export.*getWorkflowRunUrl" src/lib/github.js

    # Verify throttling configured
    grep "onRateLimit" src/lib/github.js
    grep "onSecondaryRateLimit" src/lib/github.js

    # Verify octokit usage
    grep "octokit.rest.issues.createComment" src/lib/github.js
    ```
  </verify>
  <done>
    - @octokit/plugin-throttling added to package.json dependencies
    - src/lib/github.js exists with postComment and getWorkflowRunUrl exports
    - Octokit configured with throttling plugin and retry logic
    - Workflow run URL includes all required context properties
  </done>
</task>

<task type="auto">
  <name>Task 2: Create error and success message formatters</name>
  <files>
    src/errors/formatter.js
  </files>
  <action>
    Create src/errors/formatter.js implementing:
    - Import getWorkflowRunUrl from ../lib/github.js
    - Export formatErrorComment(error, workflowUrl) function:
      * Extract error.message and error.stack
      * Return markdown with:
        - "## Error: {message}" heading
        - Brief description
        - **Workflow Run:** link with workflowUrl
        - ### Next Steps section with 4-5 actionable items
        - Collapsible &lt;details&gt; section with stack trace in code block
      * No emojis (per 04-CONTEXT.md - professional text only)

    - Export formatSuccessComment(result, workflowUrl) function:
      * Return markdown with:
        - "## Command Completed Successfully" heading
        - **Workflow Run:** link with workflowUrl
        - ### Summary section with result.summary
        - Optional ### Files Created table (if result.filesCreated exists)
        - Optional ### Decisions Made list (if result.decisions exists)
      * Rich formatting: tables, lists, code blocks, headings
      * No emojis

    Reference Pattern 7 and Pattern 8 from 04-RESEARCH.md for error formatting and markdown structure.

    **Critical formatting requirements from 04-CONTEXT.md:**
    - Technical & precise tone (not casual)
    - Rich markdown (tables, code blocks, collapsible sections)
    - No emojis anywhere
    - Always include workflow run links
    - Always provide actionable next steps in errors
  </action>
  <verify>
    ```bash
    # Verify module created and exports
    test -f src/errors/formatter.js
    grep -E "export.*formatErrorComment|export.*formatSuccessComment" src/errors/formatter.js

    # Verify imports getWorkflowRunUrl
    grep "import.*getWorkflowRunUrl" src/errors/formatter.js

    # Verify error formatting structure
    grep "## Error:" src/errors/formatter.js
    grep "<details>" src/errors/formatter.js
    grep "### Next Steps" src/errors/formatter.js

    # Verify success formatting structure
    grep "## Command Completed Successfully" src/errors/formatter.js
    grep "### Summary" src/errors/formatter.js
    ```
  </verify>
  <done>
    - src/errors/formatter.js exists with formatErrorComment and formatSuccessComment exports
    - Error messages include workflow URLs, next steps, and collapsible stack traces
    - Success messages include workflow URLs, summaries, and optional file/decision tables
    - All formatting uses professional tone with rich markdown, no emojis
  </done>
</task>

<task type="auto">
  <name>Task 3: Rebuild bundle with new dependencies</name>
  <files>
    dist/index.js
    dist/licenses.txt
  </files>
  <action>
    Rebuild the action bundle to include @octokit/plugin-throttling and new modules:
    ```bash
    npm run build
    ```

    Verify bundle includes:
    - @octokit/plugin-throttling code
    - src/lib/github.js functions
    - src/errors/formatter.js functions

    Check bundle size remains reasonable (should be similar to Phase 3 size ~32k lines + throttling plugin overhead).
  </action>
  <verify>
    ```bash
    # Verify bundle rebuilt
    test -f dist/index.js
    test -f dist/licenses.txt

    # Verify throttling plugin bundled
    grep -q "plugin-throttling" dist/index.js && echo "Throttling plugin bundled" || echo "ERROR: Plugin missing"

    # Check bundle size
    wc -l dist/index.js
    ```
  </verify>
  <done>
    - dist/index.js rebuilt with @octokit/plugin-throttling and new modules
    - dist/licenses.txt updated with plugin license
    - Bundle size verified (expected ~33k-35k lines with throttling plugin)
    - No build errors or warnings
  </done>
</task>

</tasks>

<verification>
Run verification checks:

```bash
# 1. Verify all files exist
test -f src/lib/github.js && echo "✓ github.js exists"
test -f src/errors/formatter.js && echo "✓ formatter.js exists"

# 2. Verify throttling installed
npm list @octokit/plugin-throttling

# 3. Verify exports
node --input-type=module -e "import {postComment, getWorkflowRunUrl} from './src/lib/github.js'; console.log('✓ github.js exports valid')"
node --input-type=module -e "import {formatErrorComment, formatSuccessComment} from './src/errors/formatter.js'; console.log('✓ formatter.js exports valid')"

# 4. Verify bundle includes new code
grep -c "plugin-throttling" dist/index.js
grep -c "formatErrorComment" dist/index.js
grep -c "postComment" dist/index.js
```

Expected outcomes:
- All test files exist
- @octokit/plugin-throttling shows in npm list
- Both modules export successfully
- Bundle contains all new functions
</verification>

<success_criteria>
Phase 4 Plan 1 is complete when:

1. **Dependency Management**
   - @octokit/plugin-throttling installed and in package.json
   - Plugin appears in dist/licenses.txt

2. **GitHub API Module (src/lib/github.js)**
   - Throttled octokit client initialized with retry logic
   - postComment() function posts to issues/PRs via REST API
   - getWorkflowRunUrl() constructs correct workflow URLs
   - Rate limit callbacks configured (primary: retry once, secondary: warn)

3. **Error Formatting (src/errors/formatter.js)**
   - formatErrorComment() creates structured error messages with:
     * Error summary heading
     * Workflow run link
     * Next steps section
     * Collapsible stack trace
   - formatSuccessComment() creates rich success messages with:
     * Success heading
     * Workflow run link
     * Summary section
     * Optional tables for files/decisions
   - No emojis in any messages (professional tone)

4. **Bundle Integrity**
   - dist/index.js rebuilt and contains all new code
   - Bundle size reasonable (~33k-35k lines)
   - No bundling errors

5. **Verification Passing**
   - All manual verification checks pass
   - Module imports work correctly
   - Bundle grep checks find expected functions
</success_criteria>

<output>
After completion, create `.planning/phases/04-github-integration-response/04-01-SUMMARY.md`

Summary should document:
- GitHub API module structure and throttling configuration
- Error/success formatting patterns established
- Bundle metrics (size, new dependencies)
- Key decisions (retry limits, markdown structure)
- Files created and their purposes
</output>
