---
phase: 01-github-action-foundation
plan: 03
type: execute
wave: 3
depends_on: ["01-02"]
files_modified:
  - .github/workflows/gsd-command-handler.yml
  - src/index.js
  - dist/index.js
autonomous: true
must_haves:
  truths:
    - "Example workflow file references the action with uses: superdejooo/gsd-github-action@v1"
    - "Workflow declares scoped permissions: contents: write, issues: write, pull-requests: write"
    - "Workflow triggers on issue_comment.created events only"
    - "Workflow uses branch-based concurrency group that cancels in-progress runs on same branch"
    - "Action exits cleanly on success and sets exit code on failure"
  artifacts:
    - path: ".github/workflows/gsd-command-handler.yml"
      provides: "Consumer workflow template for using the GSD action"
      contains: "on: issue_comment", "permissions:", "concurrency:", "uses: superdejooo/gsd-github-action@v1"
    - path: "src/index.js"
      provides: "Updated entry point with exit handling"
      contains: "core.setFailed", "try", "catch"
    - path: "dist/index.js"
      provides: "Bundled action with exit handling"
  key_links:
    - from: ".github/workflows/gsd-command-handler.yml"
      to: "action.yml"
      via: "uses statement referencing the action"
      pattern: "uses: .*gsd-github-action@v1"
    - from: ".github/workflows/gsd-command-handler.yml"
      to: "concurrency group"
      via: "github.head_ref || github.ref expression"
      pattern: "\\${{ github.head_ref \\|\\| github.ref }}"
    - from: "src/index.js"
      to: "GitHub Actions exit status"
      via: "core.setFailed() on error"
      pattern: "core.setFailed"
---

<objective>
Create the consumer workflow file with scoped permissions, branch-based concurrency control, and ensure clean action exit handling.

Purpose: Provide a working example workflow that users can add to their repositories to trigger the GSD action, with proper security (scoped permissions) and concurrency control (one run per branch).
Output: Example workflow file in .github/workflows/ with proper triggers, permissions, and concurrency; updated action entry point with clean exit.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md
@.planning/STATE.md

@.planning/phases/01-github-action-foundation/01-RESEARCH.md
@.planning/phases/01-github-action-foundation/01-01-SUMMARY.md
@.planning/phases/01-github-action-foundation/01-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Create example workflow file with scoped permissions</name>
  <files>.github/workflows/gsd-command-handler.yml</files>
  <action>
    Create .github/workflows/gsd-command-handler.yml following RESEARCH.md Pattern 2:

    ```yaml
    name: GSD Command Handler

    on:
      issue_comment:
        types: [created]

    permissions:
      contents: write
      issues: write
      pull-requests: write

    jobs:
      handle-gsd-command:
        runs-on: ubuntu-latest
        steps:
          - uses: superdejooo/gsd-github-action@v1
            with:
              issue-number: ${{ github.event.issue.number }}
              repo-owner: ${{ github.repository_owner }}
              repo-name: ${{ github.event.repository.name }}
              comment-body: ${{ github.event.comment.body }}
    ```

    Key requirements from WORK-05, AUTH-01, AUTH-02, PARS-04, CONC-01, CONC-02:
    - Triggers on issue_comment.created only (not edited/deleted)
    - Explicit scoped permissions: contents: write, issues: write, pull-requests: write (NOT write-all)
    - Uses superdejooo/gsd-github-action@v1 reference pattern
    - Passes GitHub event context as inputs (issue number, repo owner/name, comment body)
    - Uses ubuntu-latest runner

    Note: Concurrency will be added in the next task (this task is scoped permissions and basic workflow structure).

  </action>
  <verify>
    `test -f .github/workflows/gsd-command-handler.yml && grep -q "issue_comment:" .github/workflows/gsd-command-handler.yml && grep -q "permissions:" .github/workflows/gsd-command-handler.yml && grep -q "contents: write" .github/workflows/gsd-command-handler.yml` returns 0
  </verify>
  <done>
    .github/workflows/gsd-command-handler.yml exists with issue_comment trigger, scoped permissions, and action reference
  </done>
</task>

<task type="auto">
  <name>Add branch-based concurrency control to workflow</name>
  <files>.github/workflows/gsd-command-handler.yml</files>
  <action>
    Update the workflow file to add concurrency control following RESEARCH.md Pattern 2:

    Add this section between 'permissions:' and 'jobs:':
    ```yaml
    concurrency:
      group: ${{ github.workflow }}-${{ github.head_ref || github.ref }}
      cancel-in-progress: true
    ```

    This implements CONC-01, CONC-02, CONC-03 requirements:
    - Group includes workflow name + branch reference (prevents cross-workflow conflicts)
    - Uses github.head_ref for PR branches, github.ref as fallback for issue comments
    - cancel-in-progress: true ensures only one run per branch

    Read the existing .github/workflows/gsd-command-handler.yml and insert this section in the correct location.

  </action>
  <verify>
    `grep -q "concurrency:" .github/workflows/gsd-command-handler.yml && grep -q "\\${{ github.head_ref \\|\\| github.ref }}" .github/workflows/gsd-command-handler.yml && grep -q "cancel-in-progress: true" .github/workflows/gsd-command-handler.yml` returns 0
  </verify>
  <done>
    Workflow has concurrency section with branch-based group and cancel-in-progress set to true
  </done>
</task>

<task type="auto">
  <name>Ensure clean exit handling in action code</name>
  <files>src/index.js, dist/index.js</files>
  <action>
    1. Read existing src/index.js (created in Plan 01)
    2. Verify the try/catch structure is correct and uses core.setFailed()
    3. Ensure the exit handling follows this pattern:
       - Success: Let execution complete (implicit exit code 0)
       - Error: Call core.setFailed(error.message) in catch block
    4. Verify NO explicit process.exit() calls (use core.setFailed instead)
    5. If exit handling needs adjustment, update src/index.js accordingly
    6. Run `npm run build` to update dist/index.js with any changes

    The src/index.js from Plan 01 should already have this correct structure. This task verifies it's correct and re-bundles if needed.

    Key requirements from RESEARCH.md Pattern 3 and anti-patterns:
    - Use core.setFailed() for errors (not process.exit())
    - No explicit return or process.exit() on success
    - Clean error messages via core.setFailed()

  </action>
  <verify>
    `grep -q "core.setFailed" src/index.js && ! grep -q "process.exit" src/index.js && test -f dist/index.js` returns 0
  </verify>
  <done>
    src/index.js has proper exit handling with core.setFailed(), dist/index.js is updated with latest bundle
  </done>
</task>

</tasks>

<verification>
- .github/workflows/gsd-command-handler.yml exists with all required sections
- Workflow triggers on issue_comment.created only
- Workflow has explicit scoped permissions (contents: write, issues: write, pull-requests: write)
- Workflow has concurrency group based on branch name with cancel-in-progress: true
- src/index.js uses core.setFailed() for error handling
- dist/index.js is the latest bundled version
- No process.exit() calls in source
</verification>

<success_criteria>

- Example workflow demonstrates complete usage pattern
- Scoped permissions follow principle of least privilege (AUTH-01, AUTH-02)
- Concurrency control prevents duplicate runs on same branch (CONC-01, CONC-02, CONC-03)
- Action exits cleanly on success and sets proper exit code on failure (WORK-04)
- Users can copy this workflow to enable GSD commands in their repositories
  </success_criteria>

<output>
After completion, create `.planning/phases/01-github-action-foundation/01-03-SUMMARY.md`
</output>
