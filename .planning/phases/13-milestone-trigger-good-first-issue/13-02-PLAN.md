---
phase: 13-milestone-trigger-good-first-issue
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/milestone/index.js
  - src/milestone/index.test.js
autonomous: true

must_haves:
  truths:
    - "new-milestone workflow works WITHOUT a milestone number"
    - "GSD determines milestone number from existing ROADMAP.md"
    - "Existing functionality (with milestone number) still works"
  artifacts:
    - path: "src/milestone/index.js"
      provides: "Milestone workflow that accepts optional number"
      exports: ["executeMilestoneWorkflow", "parseMilestoneNumber"]
  key_links:
    - from: "src/milestone/index.js"
      to: ".planning/ROADMAP.md"
      via: "GSD reads roadmap to determine next milestone"
      pattern: "GSD"
---

<objective>
Refactor new-milestone workflow to make milestone number optional. When not provided, GSD determines the number from existing planning artifacts.

Purpose: Enable label-triggered milestone creation where GSD auto-determines the number
Output: Updated index.js with optional milestone number handling
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Module to modify
@src/milestone/index.js
@src/milestone/index.test.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Make milestone number optional in executeMilestoneWorkflow</name>
  <files>src/milestone/index.js</files>
  <action>
Modify executeMilestoneWorkflow to handle missing milestone number:

1. Change Step 1 from:
```javascript
// Step 1: Parse milestone number from arguments
const milestoneNumber = parseMilestoneNumber(commandArgs);
```
To:
```javascript
// Step 1: Parse milestone number from arguments (optional)
let milestoneNumber;
try {
  milestoneNumber = parseMilestoneNumber(commandArgs);
  core.info(`Parsed milestone number: ${milestoneNumber}`);
} catch (e) {
  // No milestone number provided - GSD will determine from ROADMAP.md
  core.info('No milestone number provided, GSD will determine next milestone');
  milestoneNumber = null;
}
```

2. Update Step 2 - make description parsing handle both cases:
- If milestoneNumber is null, the entire commandArgs is the description
- If milestoneNumber exists, parse description after removing number

3. Update branch creation logic:
- If milestoneNumber is null, skip branch creation - GSD handles it
- If milestoneNumber exists, use existing branch creation

4. Update state loading:
- If milestoneNumber is null, skip state loading (GSD manages state)
- If milestoneNumber exists, load state as before

5. For label trigger (no milestone number):
- Execute CCR command with just description/prompt
- GSD reads existing ROADMAP.md to determine next milestone number
- GSD creates planning artifacts
- Return { complete: true, phase: 'gsd-managed' }

CRITICAL: Keep existing behavior when milestone number IS provided. This is additive, not replacement.
  </action>
  <verify>
npm test -- src/milestone/index.test.js
All existing tests still pass
  </verify>
  <done>
executeMilestoneWorkflow works with AND without milestone number
When no number, logs "GSD will determine" message
  </done>
</task>

<task type="auto">
  <name>Task 2: Add tests for optional milestone number</name>
  <files>src/milestone/index.test.js</files>
  <action>
Add new test cases to index.test.js:

```javascript
describe('executeMilestoneWorkflow with optional milestone number', () => {
  it('should work without milestone number (description only)', async () => {
    // Mock CCR execution
    // Call with just description: 'Build a login system'
    // Verify it doesn't throw
    // Verify it logs "GSD will determine"
  });

  it('should still work with milestone number (backward compatible)', async () => {
    // Call with: '2 Build a login system'
    // Verify milestoneNumber is parsed
    // Verify branch creation attempted
  });

  it('should pass full description as prompt when no number', async () => {
    // Verify the entire commandArgs becomes the prompt
    // No stripping of milestone number
  });
});
```

Mock pattern from existing tests:
- vi.mock for child_process exec
- Mock fs operations
- Mock postComment
  </action>
  <verify>
npm test -- src/milestone/index.test.js
All tests pass including new optional milestone tests
  </verify>
  <done>
Tests cover both with-number and without-number cases
Backward compatibility verified
  </done>
</task>

</tasks>

<verification>
1. npm test -- src/milestone/index.test.js - all tests pass
2. Existing milestone workflow tests still pass (backward compat)
3. New tests for optional milestone number pass
</verification>

<success_criteria>
- executeMilestoneWorkflow accepts commandArgs with or without milestone number
- When no number: logs "GSD will determine", skips branch creation, passes full prompt
- When number present: existing behavior preserved exactly
- All tests pass (old and new)
</success_criteria>

<output>
After completion, create `.planning/phases/13-milestone-trigger-good-first-issue/13-02-SUMMARY.md`
</output>
