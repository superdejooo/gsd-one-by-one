---
phase: 13-milestone-trigger-good-first-issue
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - .github/workflows/gsd-label-trigger.yml
  - src/milestone/label-trigger.js
  - src/milestone/label-trigger.test.js
autonomous: true

must_haves:
  truths:
    - "Workflow triggers when issue receives 'good first issue' label"
    - "Issue title and body are read and joined with '---' separator"
    - "GSD new-milestone command is invoked via CCR with issue content as prompt"
  artifacts:
    - path: ".github/workflows/gsd-label-trigger.yml"
      provides: "GitHub Actions workflow for label trigger"
      contains: "issues.labeled"
    - path: "src/milestone/label-trigger.js"
      provides: "Label trigger workflow orchestrator"
      exports: ["executeLabelTriggerWorkflow"]
  key_links:
    - from: ".github/workflows/gsd-label-trigger.yml"
      to: "src/index.js"
      via: "GitHub Actions uses directive"
      pattern: "uses: ./"
    - from: "src/milestone/label-trigger.js"
      to: "src/llm/ccr-command.js"
      via: "import formatCcrCommandWithOutput"
      pattern: "import.*formatCcrCommandWithOutput"
---

<objective>
Create new GitHub Actions workflow that triggers on "good first issue" label and orchestrator module that invokes GSD new-milestone with issue content as prompt.

Purpose: Enable automatic milestone creation when maintainers label an issue as "good first issue"
Output: Workflow file + label-trigger.js module with tests
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Existing patterns to follow
@.github/workflows/gsd-command-handler.yml
@src/milestone/phase-planner.js
@src/llm/ccr-command.js
@src/index.js
@action.yml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create label trigger workflow</name>
  <files>.github/workflows/gsd-label-trigger.yml</files>
  <action>
Create new workflow file that:
1. Triggers on `issues.labeled` event (NOT issue_comment)
2. Has job-level conditional: `if: github.event.label.name == 'good first issue'`
3. Follows same setup pattern as gsd-command-handler.yml:
   - Checkout, Node.js setup, npm ci
   - Install Bun, Claude Code, CCR, GSD Skill
   - Generate CCR config, start CCR service
4. Pass different inputs to the action:
   - `issue-number`: `${{ github.event.issue.number }}`
   - `trigger-type`: `label` (new input to distinguish from comment trigger)
   - `issue-title`: `${{ github.event.issue.title }}`
   - `issue-body`: `${{ github.event.issue.body }}`

Key differences from gsd-command-handler.yml:
- Trigger: `issues: types: [labeled]` not `issue_comment`
- Conditional: checks label name, not comment content
- No comment-body input, instead issue-title and issue-body inputs
  </action>
  <verify>
File exists at .github/workflows/gsd-label-trigger.yml
Contains: `issues:` and `types: [labeled]`
Contains: `github.event.label.name == 'good first issue'`
  </verify>
  <done>
Workflow triggers on label event and passes issue content to action
  </done>
</task>

<task type="auto">
  <name>Task 2: Create label trigger orchestrator module</name>
  <files>src/milestone/label-trigger.js, src/milestone/label-trigger.test.js</files>
  <action>
Create src/milestone/label-trigger.js with:

```javascript
export async function executeLabelTriggerWorkflow(context) {
  const { owner, repo, issueNumber, issueTitle, issueBody } = context;

  // 1. Join title and body with --- separator
  const prompt = `${issueTitle}\n---\n${issueBody}`;

  // 2. Execute GSD new-milestone via CCR with prompt
  // Use formatCcrCommandWithOutput with /gsd:new-milestone and prompt
  const outputPath = `output-${Date.now()}.txt`;
  const command = formatCcrCommandWithOutput(
    '/gsd:new-milestone',
    outputPath,
    prompt,  // Pass issue content as prompt
    null     // No skill override
  );

  // 3. Execute command (same pattern as phase-planner.js)
  // 4. Read output, check for errors
  // 5. Return result with complete flag
}
```

Import pattern from phase-planner.js:
- exec from child_process, promisify from util
- fs from fs/promises
- postComment from lib/github.js
- formatCcrCommandWithOutput from llm/ccr-command.js

Create src/milestone/label-trigger.test.js with tests:
- Test prompt formatting (title + --- + body)
- Test command construction with prompt
- Test error handling (CCR failure)
- Mock execAsync and fs operations

IMPORTANT: Do NOT call postComment after GSD completes - the output parsing and issue update will happen in 13-03 and 13-04 plans.
  </action>
  <verify>
npm test -- src/milestone/label-trigger.test.js
All tests pass
  </verify>
  <done>
label-trigger.js exports executeLabelTriggerWorkflow
Prompt correctly joins title + --- + body
CCR command includes prompt parameter
  </done>
</task>

<task type="auto">
  <name>Task 3: Update action.yml and index.js for label trigger</name>
  <files>action.yml, src/index.js</files>
  <action>
1. Update action.yml to add new inputs:
```yaml
inputs:
  # ... existing inputs ...
  trigger-type:
    description: "Type of trigger: comment or label"
    required: false
    default: "comment"
  issue-title:
    description: "Issue title (for label trigger)"
    required: false
  issue-body:
    description: "Issue body (for label trigger)"
    required: false
```

2. Update src/index.js to handle label trigger:
- Import executeLabelTriggerWorkflow from ./milestone/label-trigger.js
- Add to module loading pattern at top
- After getting inputs, check trigger-type:
```javascript
const triggerType = core.getInput('trigger-type') || 'comment';
const issueTitle = core.getInput('issue-title');
const issueBody = core.getInput('issue-body');

// In withErrorHandling callback:
if (triggerType === 'label') {
  core.info('Label trigger detected, dispatching to label workflow');
  const result = await executeLabelTriggerWorkflow({
    owner: repoOwner,
    repo: repoName,
    issueNumber: github.context.issue?.number,
    issueTitle,
    issueBody,
  });
  core.setOutput('label-trigger-complete', result.complete);
  return { commandFound: true, ...result };
}
// ... existing comment parsing logic ...
```

IMPORTANT: Label trigger bypasses authorization check - it's already gated by who can add labels (write access required).
  </action>
  <verify>
npm run build
npm test -- src/index.test.js
Build succeeds without errors
  </verify>
  <done>
action.yml has trigger-type, issue-title, issue-body inputs
index.js dispatches to label trigger when trigger-type is 'label'
  </done>
</task>

</tasks>

<verification>
1. npm run build - bundle compiles without errors
2. npm test - all tests pass
3. Workflow file validates (check YAML syntax)
4. Label trigger module exports executeLabelTriggerWorkflow
</verification>

<success_criteria>
- New workflow file exists at .github/workflows/gsd-label-trigger.yml
- Workflow triggers on issues.labeled with "good first issue" filter
- label-trigger.js joins title + body and passes to CCR
- action.yml accepts new inputs for label trigger
- index.js routes label triggers to new workflow
- All existing tests still pass
</success_criteria>

<output>
After completion, create `.planning/phases/13-milestone-trigger-good-first-issue/13-01-SUMMARY.md`
</output>
