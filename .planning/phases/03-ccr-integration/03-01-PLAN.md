---
phase: 03-ccr-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - package-lock.json
  - dist/index.js
autonomous: true

must_haves:
  truths:
    - "Anthropic Agent SDK is bundled for LLM client operations"
    - "Agent SDK version is locked for reproducible builds"
    - "Bundled action contains Agent SDK code for offline execution"
  artifacts:
    - path: "package.json"
      provides: "@anthropic-ai/claude-agent-sdk dependency"
      contains: "@anthropic-ai/claude-agent-sdk"
    - path: "package-lock.json"
      provides: "Locked SDK version"
      min_lines: 50
    - path: "dist/index.js"
      provides: "Bundled action with SDK included"
      min_lines: 30000
  key_links:
    - from: "package.json"
      to: "dist/index.js"
      via: "npm run build (ncc bundler)"
      pattern: "ncc build"
---

<objective>
Install Anthropic Agent SDK as production dependency with pinned version and verify bundling.

Purpose: Establish the LLM client layer for GitHub Action commands. Agent SDK connects to Claude Code Router proxy service (installed separately in workflow) via ANTHROPIC_BASE_URL, enabling multi-provider routing while using official Anthropic tooling.

Output: Agent SDK installed in package.json, bundled into dist/index.js, ready for programmatic usage with CCR proxy in subsequent plans.

**Architecture:** CCR proxy service (installed globally in workflow) + Agent SDK client library (bundled in action). Agent SDK routes to CCR via ANTHROPIC_BASE_URL environment variable.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-ccr-integration/03-RESEARCH.md
@.planning/phases/03-ccr-integration/03-RESEARCH-CCR.md

# Prior phase context
@.planning/phases/01-github-action-foundation/01-02-SUMMARY.md
@.planning/phases/02-command-parsing-config/02-03-SUMMARY.md

# Files to modify
@package.json
@action.yml
</context>

<tasks>

<task type="auto">
  <name>Install Agent SDK with pinned version</name>
  <files>package.json, package-lock.json</files>
  <action>
Add `@anthropic-ai/claude-agent-sdk` to package.json dependencies with pinned version (not ^latest):

```bash
npm install @anthropic-ai/claude-agent-sdk@latest
```

Then pin the exact version in package.json by removing the ^ prefix (e.g., change `"^0.1.5"` to `"0.1.5"`).

**Why Agent SDK (not CCR)**: CCR is a proxy SERVICE installed globally in workflows (not a bundled library). Agent SDK is the CLIENT library that routes through CCR when ANTHROPIC_BASE_URL points to CCR proxy endpoint.

**Why pin the version**: CCR-02 requires version pinning (not user-configurable). Pinning ensures reproducible builds and prevents unexpected breaking changes in CI.

**Architecture clarification**:
- CCR (@musistudio/claude-code-router): Installed globally via workflow (`npm install -g`), runs as background service
- Agent SDK (@anthropic-ai/claude-agent-sdk): Installed as dependency, bundled into dist/index.js, connects to CCR proxy

**What NOT to do**:
- Do NOT install CCR as package.json dependency (it's a global CLI tool)
- Do NOT install globally (`npm install -g`) - Agent SDK must be package.json dependency for bundling
- Do NOT install `@anthropic-ai/sdk` separately - it's a peer dependency of Agent SDK
  </action>
  <verify>
```bash
# Verify package.json contains pinned version (no ^ or ~ prefix)
grep -E '"@anthropic-ai/claude-agent-sdk": "[0-9]' package.json

# Verify package-lock.json was updated
grep -q "@anthropic-ai/claude-agent-sdk" package-lock.json && echo "Lock file updated"

# Verify node_modules contains SDK
test -d node_modules/@anthropic-ai/claude-agent-sdk && echo "SDK installed"
```
  </verify>
  <done>package.json contains @anthropic-ai/claude-agent-sdk with exact version number (no ^ prefix), package-lock.json updated, node_modules contains SDK</done>
</task>

<task type="auto">
  <name>Bundle SDK into distributable</name>
  <files>dist/index.js, dist/licenses.txt</files>
  <action>
Run the existing build script to bundle Agent SDK into dist/index.js:

```bash
npm run build
```

This uses @vercel/ncc (already configured in 01-02) to create a single-file bundle with all dependencies inline.

Verify the bundle:
- dist/index.js size should increase significantly (Agent SDK adds substantial code)
- dist/licenses.txt should include Anthropic SDK licenses
- Bundle should contain Agent SDK code (check for "anthropic" or "claude" strings)

**Why this works**: Phase 01-02 already established the ncc bundling pattern. The build script (`ncc build src/index.js --license licenses.txt`) will automatically include the new Agent SDK dependency.

**What to verify**:
- Bundle size increases (baseline ~32KB from 01-02, expect 100KB+ with SDK)
- No bundling errors or warnings
- dist/licenses.txt contains Anthropic license text

**Note**: CCR is NOT bundled (it's installed globally in workflow step). Only Agent SDK client library is bundled.
  </action>
  <verify>
```bash
# Verify bundle was created and is larger than baseline
test -f dist/index.js && echo "Bundle exists"
wc -l dist/index.js  # Should be significantly more than 31,998 lines from 01-02

# Verify SDK code is bundled
grep -qi "anthropic" dist/index.js && echo "SDK bundled"

# Verify licenses updated
grep -qi "anthropic" dist/licenses.txt && echo "Licenses include Anthropic"
```
  </verify>
  <done>dist/index.js exists with increased size containing Agent SDK code, dist/licenses.txt includes Anthropic licenses, build completes without errors</done>
</task>

</tasks>

<verification>
Run all task verification commands in sequence. Success criteria:
- package.json contains @anthropic-ai/claude-agent-sdk with pinned version (no ^ or ~)
- package-lock.json contains locked SDK version
- node_modules/@anthropic-ai/claude-agent-sdk directory exists
- dist/index.js contains bundled SDK code (grep finds "anthropic")
- dist/licenses.txt contains Anthropic license text
- Build completes without errors or warnings
</verification>

<success_criteria>
**Requirements satisfied**: CCR-01 (SDK bundled for CI), CCR-02 (pinned version), CCR-06 (installed via package manager)

**Observable behaviors**:
1. `npm install` succeeds and installs Agent SDK
2. `npm run build` succeeds and bundles SDK into dist/index.js
3. Bundle contains Agent SDK code (verifiable via grep)
4. Version is pinned in package.json (no ^ or ~ prefix)

**Files created/modified**:
- package.json: Added @anthropic-ai/claude-agent-sdk dependency
- package-lock.json: Locked SDK version and dependencies
- dist/index.js: Bundled action code including Agent SDK
- dist/licenses.txt: Updated with Anthropic licenses

**Ready for next plan**: Agent SDK available for programmatic import in src/llm/agent.js wrapper (Plan 03-02). CCR service lifecycle will be added to workflow in Plan 03-03.

**Architecture note**: CCR proxy service will be installed globally in workflow (`npm install -g @musistudio/claude-code-router@2.0.0`), not bundled here. This plan bundles the CLIENT library (Agent SDK) that connects to CCR proxy.
</success_criteria>

<output>
After completion, create `.planning/phases/03-ccr-integration/03-01-SUMMARY.md` with:
- Performance metrics (duration, files modified)
- Installed SDK version
- Bundle size comparison (before/after)
- Any deviations from plan
- Verification results
- Architecture clarification (CCR service vs Agent SDK client)
</output>
