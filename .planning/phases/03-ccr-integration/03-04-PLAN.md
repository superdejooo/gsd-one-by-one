---
phase: 03-ccr-integration
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - src/llm/config-generator.js
  - package.json
  - .github/workflows/gsd-command-handler.yml
  - dist/index.js
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "CCR runs in non-interactive mode without TTY prompts"
    - "Architecture is consistent: stdin pipe only, no Agent SDK remnants"
    - "Package dependencies align with chosen execution approach"
  artifacts:
    - path: "src/llm/config-generator.js"
      provides: "CCR config with NON_INTERACTIVE_MODE: true"
      contains: "NON_INTERACTIVE_MODE"
    - path: "package.json"
      provides: "Dependencies without Agent SDK"
      excludes: "@anthropic-ai/claude-agent-sdk"
    - path: ".github/workflows/gsd-command-handler.yml"
      provides: "Workflow without ANTHROPIC_BASE_URL"
      excludes: "ANTHROPIC_BASE_URL"
  key_links:
    - from: "src/llm/config-generator.js"
      to: "~/.claude-code-router/config.json"
      via: "fs.writeFileSync"
      pattern: "NON_INTERACTIVE_MODE.*true"
---

<objective>
Close verification gaps in Phase 3 CCR Integration

Purpose: The verification report identified incomplete architecture cleanup after the Agent SDK to stdin pipe pivot. This plan removes contradictory artifacts and adds the missing NON_INTERACTIVE_MODE setting required for CI-safe execution.

Output:
- CCR config generator with NON_INTERACTIVE_MODE: true
- package.json without deprecated Agent SDK dependency
- Workflow without orphaned ANTHROPIC_BASE_URL env var
- Rebuilt bundle reflecting cleaned dependencies
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-ccr-integration/03-VERIFICATION.md
@.planning/phases/03-ccr-integration/03-03-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add NON_INTERACTIVE_MODE to CCR config generator</name>
  <files>src/llm/config-generator.js</files>
  <action>
Add NON_INTERACTIVE_MODE: true to the config object in generateCCRConfig().

Location: Add as top-level property in the config object (around line 19-20).

The config object should include:
```javascript
"NON_INTERACTIVE_MODE": true,
```

This setting is required by CCR-07 (CCR runs in non-interactive mode) to prevent CI workflow hangs from interactive prompts.

DO NOT modify any other settings. The rest of the config structure is correct.
  </action>
  <verify>
Run: `grep -n "NON_INTERACTIVE_MODE" src/llm/config-generator.js`
Expected: Line showing `"NON_INTERACTIVE_MODE": true,`
  </verify>
  <done>NON_INTERACTIVE_MODE: true present in config generator</done>
</task>

<task type="auto">
  <name>Task 2: Remove Agent SDK dependency and orphaned workflow env var</name>
  <files>package.json, .github/workflows/gsd-command-handler.yml</files>
  <action>
**package.json:**
Remove the @anthropic-ai/claude-agent-sdk dependency from the dependencies object.

Current state:
```json
"dependencies": {
  "@actions/core": "^2.0.2",
  "@actions/github": "^7.0.0",
  "@anthropic-ai/claude-agent-sdk": "0.2.14"  // REMOVE THIS LINE
}
```

After:
```json
"dependencies": {
  "@actions/core": "^2.0.2",
  "@actions/github": "^7.0.0"
}
```

Rationale: Agent SDK is deprecated per 03-03 architecture pivot. Stdin pipe execution via CCR does not use the SDK.

**.github/workflows/gsd-command-handler.yml:**
Remove the ANTHROPIC_BASE_URL environment variable from the "Run Action" step.

Current state (lines 55-60):
```yaml
- name: Run Action
  uses: ./
  env:
    ANTHROPIC_BASE_URL: http://127.0.0.1:3456  # REMOVE THIS LINE
    GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
```

After:
```yaml
- name: Run Action
  uses: ./
  env:
    GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
```

Rationale: ANTHROPIC_BASE_URL was for Agent SDK routing through CCR proxy. With stdin pipe execution, this env var is unused and causes architecture confusion.
  </action>
  <verify>
Run: `grep -c "claude-agent-sdk" package.json` - Expected: 0
Run: `grep -c "ANTHROPIC_BASE_URL" .github/workflows/gsd-command-handler.yml` - Expected: 0
  </verify>
  <done>Agent SDK dependency removed, ANTHROPIC_BASE_URL removed from workflow</done>
</task>

<task type="auto">
  <name>Task 3: Rebuild bundle and verify</name>
  <files>dist/index.js, dist/licenses.txt</files>
  <action>
Rebuild the bundle to reflect cleaned dependencies:

1. Run `npm run build` to rebuild with @vercel/ncc
2. Verify bundle does not contain Agent SDK references
3. Note final bundle line count for summary

Expected outcome: Bundle should be smaller (no Agent SDK code) and not contain references to @anthropic-ai/claude-agent-sdk.

IMPORTANT: The setup:ccr script in package.json uses CommonJS require() but the project is ESM. This may fail. If it does, also update the setup:ccr script to use proper ESM import.

If setup:ccr script fails:
- Change from: `"setup:ccr": "node -e \"require('./src/llm/config-generator.js').generateCCRConfig()\""`
- Change to: `"setup:ccr": "node --input-type=module -e \"import {generateCCRConfig} from './src/llm/config-generator.js'; generateCCRConfig()\""`
  </action>
  <verify>
Run: `npm run build` - Expected: Build succeeds
Run: `grep -c "claude-agent-sdk" dist/index.js` - Expected: 0
Run: `wc -l dist/index.js` - Note line count (should be ~32,000 or less)
  </verify>
  <done>Bundle rebuilt without Agent SDK references</done>
</task>

</tasks>

<verification>
After all tasks complete:

1. **Config check:**
   - `node --input-type=module -e "import {generateCCRConfig} from './src/llm/config-generator.js'; import fs from 'fs'; import os from 'os'; import path from 'path'; generateCCRConfig(); const config = JSON.parse(fs.readFileSync(path.join(os.homedir(), '.claude-code-router/config.json'))); console.log('NON_INTERACTIVE_MODE:', config.NON_INTERACTIVE_MODE);"`
   - Expected: `NON_INTERACTIVE_MODE: true`

2. **Dependency check:**
   - `grep "claude-agent-sdk" package.json` should return nothing

3. **Workflow check:**
   - `grep "ANTHROPIC_BASE_URL" .github/workflows/gsd-command-handler.yml` should return nothing

4. **Bundle check:**
   - `grep "claude-agent-sdk" dist/index.js` should return nothing
</verification>

<success_criteria>
- NON_INTERACTIVE_MODE: true present in CCR config generator
- @anthropic-ai/claude-agent-sdk removed from package.json dependencies
- ANTHROPIC_BASE_URL removed from workflow env vars
- Bundle rebuilt without Agent SDK references
- All verification checks pass
</success_criteria>

<output>
After completion, create `.planning/phases/03-ccr-integration/03-04-SUMMARY.md` using the summary template.

Include:
- Gap closure context (which gaps were addressed)
- Files modified
- Verification results
- Any deviations or issues encountered
</output>
