---
phase: 03-ccr-integration
plan: 03
type: execute
wave: 3
depends_on: ["03-02"]
files_modified:
  - action.yml
  - .github/workflows/gsd-command-handler.yml
autonomous: false

must_haves:
  truths:
    - "Action accepts ANTHROPIC_API_KEY input from workflow secrets"
    - "Workflow passes API key to action as environment variable"
    - "SDK can authenticate using environment variable in CI"
    - "Non-interactive execution works (no prompts, no hangs)"
  artifacts:
    - path: "action.yml"
      provides: "Action inputs including api-key"
      contains: "api-key"
    - path: ".github/workflows/gsd-command-handler.yml"
      provides: "Workflow with ANTHROPIC_API_KEY environment variable"
      contains: "ANTHROPIC_API_KEY"
  key_links:
    - from: ".github/workflows/gsd-command-handler.yml"
      to: "action.yml"
      via: "secrets.ANTHROPIC_API_KEY input"
      pattern: "api-key:.*secrets"
    - from: "action.yml"
      to: "src/llm/agent.js"
      via: "ANTHROPIC_API_KEY environment variable"
      pattern: "ANTHROPIC_API_KEY"
---

<objective>
Configure API key passing from workflow secrets to Agent SDK and verify non-interactive execution.

Purpose: Complete the LLM integration by establishing the authentication flow (workflow secret → action input → environment variable → SDK) and prove the system works end-to-end in CI without prompts or hangs.

Output: Action configured to accept API key, workflow updated to pass secret, integration verified via build/test process.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-ccr-integration/03-RESEARCH.md

# Prior plan context
@.planning/phases/03-ccr-integration/03-01-SUMMARY.md
@.planning/phases/03-ccr-integration/03-02-SUMMARY.md

# Files to modify
@action.yml
@.github/workflows/gsd-command-handler.yml
</context>

<tasks>

<task type="auto">
  <name>Add API key input to action</name>
  <files>action.yml</files>
  <action>
Update `action.yml` to add `api-key` input:

Add to `inputs:` section:
```yaml
  api-key:
    description: 'Anthropic API key for LLM execution'
    required: true
```

**Why required: true**: API key is mandatory for LLM functionality. Action should fail fast with clear error if not provided, rather than failing later with obscure SDK errors.

**Position**: Add after existing inputs (issue-number, repo-owner, repo-name, comment-body, token).

**Note**: The workflow will pass `secrets.ANTHROPIC_API_KEY` to this input. The SDK will automatically read from `ANTHROPIC_API_KEY` environment variable (no explicit config file needed - satisfies CCR-03).
  </action>
  <verify>
```bash
# Verify api-key input added
grep -q "api-key:" action.yml && echo "API key input added"
grep -A2 "api-key:" action.yml | grep -q "required: true" && echo "Required flag set"

# Verify input positioned correctly (after other inputs, before runs:)
grep -B5 "runs:" action.yml | grep -q "api-key:" && echo "Input in correct position"
```
  </verify>
  <done>action.yml includes api-key input with required: true, positioned with other inputs</done>
</task>

<task type="auto">
  <name>Update workflow to pass API key</name>
  <files>.github/workflows/gsd-command-handler.yml</files>
  <action>
Update `.github/workflows/gsd-command-handler.yml` to pass API key from secrets:

Find the existing `uses: ./` step (currently has issue-number, repo-owner, repo-name, comment-body, token inputs).

Add `api-key` input:
```yaml
        with:
          issue-number: ${{ github.event.issue.number }}
          repo-owner: ${{ github.repository_owner }}
          repo-name: ${{ github.event.repository.name }}
          comment-body: ${{ github.event.comment.body }}
          token: ${{ secrets.GITHUB_TOKEN }}
          api-key: ${{ secrets.ANTHROPIC_API_KEY }}
```

Also add `ANTHROPIC_API_KEY` to the `env:` section of the step:
```yaml
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
```

**Why both input and env**: Input passes value to action.yml (explicit contract). Environment variable ensures SDK can auto-detect the key (SDK pattern from RESEARCH.md).

**Note**: `secrets.ANTHROPIC_API_KEY` will be set by repository owner in GitHub Settings → Secrets and variables → Actions. We're establishing the configuration pattern; actual secret setup is user responsibility (will be documented in README).
  </action>
  <verify>
```bash
# Verify api-key input added to workflow
grep -q "api-key:.*secrets.ANTHROPIC_API_KEY" .github/workflows/gsd-command-handler.yml && echo "API key input configured"

# Verify environment variable set
grep -q "ANTHROPIC_API_KEY:.*secrets.ANTHROPIC_API_KEY" .github/workflows/gsd-command-handler.yml && echo "Environment variable configured"

# Verify YAML syntax valid
node -e "require('js-yaml').load(require('fs').readFileSync('.github/workflows/gsd-command-handler.yml', 'utf8'))" && echo "YAML valid"
```
  </verify>
  <done>Workflow passes secrets.ANTHROPIC_API_KEY as both action input and environment variable, YAML syntax valid</done>
</task>

<task type="auto">
  <name>Rebuild with complete integration</name>
  <files>dist/index.js</files>
  <action>
Run build to verify complete integration (SDK + wrapper + imports) bundles successfully:

```bash
npm run build
```

Verify:
- Build completes without errors
- No circular dependency warnings
- dist/index.js updated with latest code
- File size remains reasonable (< 500KB)

**Why rebuild**: Ensures all new modules (src/llm/agent.js, src/llm/prompts.js) and imports in src/index.js bundle correctly. Catches module resolution issues before deployment.

If build succeeds, the bundled action is ready for non-interactive testing (next task).
  </action>
  <verify>
```bash
# Verify build succeeds
npm run build 2>&1 | tee build.log
grep -qi "error" build.log && echo "Build errors found" && exit 1 || echo "Build successful"

# Verify bundle updated
test -f dist/index.js && echo "Bundle exists"
stat -f%z dist/index.js  # Check file size

# Verify LLM modules bundled
grep -q "executeLLMTask" dist/index.js && echo "Agent wrapper bundled"
grep -q "createMilestonePrompt" dist/index.js && echo "Prompts bundled"
```
  </verify>
  <done>npm run build succeeds, dist/index.js updated with LLM modules, no errors or circular dependencies</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete LLM integration with Agent SDK bundled, wrapper configured for non-interactive mode, and API key flow from secrets to environment variable.

**Configuration established**:
- Agent SDK installed and bundled (Plan 03-01)
- LLM wrapper with permissionMode: acceptEdits (Plan 03-02)
- API key input in action.yml (this plan, Task 1)
- Workflow secret passing (this plan, Task 2)
- Environment variable pattern (ANTHROPIC_API_KEY)

**Not yet executed**: No actual LLM calls in this phase. Command execution logic will be added in Phase 5 (Milestone Creation Workflow).
  </what-built>

  <how-to-verify>
Verify the integration is correctly configured:

**1. Check action.yml configuration**:
```bash
cat action.yml
# Look for api-key input with required: true
```

**2. Check workflow configuration**:
```bash
cat .github/workflows/gsd-command-handler.yml
# Look for api-key: ${{ secrets.ANTHROPIC_API_KEY }}
# Look for env: ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
```

**3. Check bundle includes LLM code**:
```bash
grep -c "executeLLMTask" dist/index.js
# Should return > 0 (function is bundled)

grep -c "permissionMode" dist/index.js
# Should return > 0 (SDK configuration is bundled)
```

**4. Check module structure**:
```bash
ls -lh src/llm/
# Should show agent.js and prompts.js

cat src/llm/agent.js | grep -A5 "permissionMode"
# Verify permissionMode: "acceptEdits" is set
```

**5. Verify imports in main file**:
```bash
cat src/index.js | head -20
# Should see imports for executeLLMTaskWithRetry and createMilestonePrompt
```

**Expected outcomes**:
- action.yml has api-key input
- Workflow passes secret to action and environment
- Bundle contains LLM wrapper code
- permissionMode set to "acceptEdits" (non-interactive)
- No execution logic yet (Phase 5)

**What we're NOT testing**: Actual LLM execution. We're verifying configuration is in place. Real LLM calls require a valid ANTHROPIC_API_KEY secret and will be tested in Phase 5.
  </how-to-verify>

  <resume-signal>
Type "approved" if configuration verified, or describe any issues found.
  </resume-signal>
</task>

</tasks>

<verification>
Phase 3 complete when:
- action.yml includes api-key input (required: true)
- Workflow passes secrets.ANTHROPIC_API_KEY as input and environment variable
- Build succeeds with LLM modules bundled
- Human verification confirms configuration correctness
- No execution logic added yet (deferred to Phase 5)
</verification>

<success_criteria>
**All Phase 3 requirements satisfied**:
- CCR-01: Agent SDK bundled for CI-safe execution ✓
- CCR-02: SDK version pinned in package.json ✓
- CCR-03: Configuration via environment variables (not config files) ✓
- CCR-04: API key interpolated from GitHub secrets ✓
- CCR-05: SDK wrapper ready to handle LLM invocations ✓
- CCR-06: SDK installed via npm with pinned version ✓
- CCR-07: permissionMode: acceptEdits ensures non-interactive execution ✓

**Observable behaviors**:
1. Action accepts api-key input
2. Workflow configured to pass ANTHROPIC_API_KEY from secrets
3. SDK reads API key from environment variable
4. Non-interactive mode configured (no prompts possible)

**Files modified**:
- action.yml: Added api-key input
- .github/workflows/gsd-command-handler.yml: Added secret passing

**Ready for Phase 4**: LLM integration infrastructure complete. Phase 4 (GitHub Integration & Response) will implement GitHub CLI operations. Phase 5 (Milestone Creation Workflow) will use executeLLMTask to implement gsd:new-milestone command.

**Security note**: Actual ANTHROPIC_API_KEY secret must be added by repository owner in GitHub Settings → Secrets and variables → Actions. This is user setup, not automated by this action.
</success_criteria>

<output>
After completion, create `.planning/phases/03-ccr-integration/03-03-SUMMARY.md` with:
- Performance metrics
- Configuration verification results
- Security/authentication flow diagram (workflow → action → env → SDK)
- User setup requirements (secret configuration)
- Any deviations from plan
- Readiness for Phase 4 and Phase 5
</output>
