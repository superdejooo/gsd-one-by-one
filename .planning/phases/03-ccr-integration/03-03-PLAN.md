---
phase: 03-ccr-integration
plan: 03
type: execute
wave: 3
depends_on: ["03-02"]
files_modified:
  - .github/workflows/gsd-command-handler.yml
  - package.json (add setup script)
autonomous: false

must_haves:
  truths:
    - "Workflow installs CCR globally and starts service before action execution"
    - "CCR config generated with multi-provider API keys before service start"
    - "ANTHROPIC_BASE_URL environment variable points to CCR proxy"
    - "Service health verified before executing action"
  artifacts:
    - path: ".github/workflows/gsd-command-handler.yml"
      provides: "Workflow with CCR service lifecycle"
      contains: "npm install -g @musistudio/claude-code-router"
    - path: "package.json"
      provides: "Setup script for config generation"
      contains: "setup:ccr"
  key_links:
    - from: ".github/workflows/gsd-command-handler.yml"
      to: "CCR service"
      via: "npm install -g, ccr start commands"
      pattern: "ccr start"
    - from: ".github/workflows/gsd-command-handler.yml"
      to: "src/llm/agent.js"
      via: "ANTHROPIC_BASE_URL environment variable"
      pattern: "ANTHROPIC_BASE_URL"
---

<objective>
Configure CCR service lifecycle in GitHub Actions workflow and verify end-to-end integration.

Purpose: Complete the LLM integration by adding CCR proxy service management to workflow (install → configure → start → verify → use). Ensures Agent SDK routes through CCR to configured providers.

Output: Workflow configured with CCR service lifecycle, environment variables set, integration verified via build/test process.

**Architecture**: Workflow installs CCR globally, generates config with multi-provider keys, starts CCR service on port 3456, sets ANTHROPIC_BASE_URL, then executes action which uses Agent SDK routing through CCR.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-ccr-integration/03-RESEARCH.md
@.planning/phases/03-ccr-integration/03-RESEARCH-CCR.md

# Prior plan context

@.planning/phases/03-ccr-integration/03-01-SUMMARY.md
@.planning/phases/03-ccr-integration/03-02-SUMMARY.md

# Files to modify

@.github/workflows/gsd-command-handler.yml
@package.json
</context>

<tasks>

<task type="auto">
  <name>Add CCR setup script to package.json</name>
  <files>package.json</files>
  <action>
Add a setup script to package.json that generates CCR config:

```json
{
  "scripts": {
    "build": "ncc build src/index.js --license licenses.txt",
    "setup:ccr": "node -e \"require('./src/llm/config-generator.js').generateCCRConfig()\""
  }
}
```

**Why this script**: Workflow needs to call `generateCCRConfig()` to create ~/.claude-code-router/config.json before starting CCR service. This script provides a convenient way to run config generation.

**Alternative approach**: Could create a standalone setup.js file, but npm script is simpler and keeps config generation encapsulated in the module.

**When called**: Workflow step runs `npm run setup:ccr` after installing dependencies but before starting CCR service.
</action>
<verify>

```bash
# Verify script added
grep -q "setup:ccr" package.json && echo "CCR setup script added"

# Verify script calls config generator
grep -q "config-generator" package.json && echo "Config generator referenced"
```

  </verify>
  <done>package.json includes setup:ccr script that calls generateCCRConfig()</done>
</task>

<task type="auto">
  <name>Add CCR service lifecycle to workflow</name>
  <files>.github/workflows/gsd-command-handler.yml</files>
  <action>
Update `.github/workflows/gsd-command-handler.yml` to add CCR service lifecycle steps.

Add these steps AFTER "Install dependencies" step and BEFORE "Run Action" step:

```yaml
- name: Install Claude Code Router
  run: npm install -g @musistudio/claude-code-router@2.0.0

- name: Generate CCR Configuration
  env:
    OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
    ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
    DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
  run: npm run setup:ccr

- name: Start CCR Service
  run: |
    nohup ccr start > ccr.log 2>&1 &
    sleep 5

    # Verify service is running
    curl -f http://127.0.0.1:3456/health || (echo "CCR service failed to start" && cat ccr.log && exit 1)

- name: Run Action
  uses: ./
  env:
    ANTHROPIC_BASE_URL: http://127.0.0.1:3456
    GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  with:
    issue-number: ${{ github.event.issue.number }}
    repo-owner: ${{ github.repository_owner }}
    repo-name: ${{ github.event.repository.name }}
    comment-body: ${{ github.event.comment.body }}
    token: ${{ secrets.GITHUB_TOKEN }}

- name: Upload CCR logs (on failure)
  if: failure()
  uses: actions/upload-artifact@v4
  with:
    name: ccr-logs
    path: |
      ccr.log
      ~/.claude-code-router/logs/
      ~/.claude-code-router/claude-code-router.log
```

**Why this order**:

1. Install CCR globally (makes `ccr` command available)
2. Generate config (creates ~/.claude-code-router/config.json with multi-provider setup)
3. Start service (`ccr start` reads config, starts proxy on port 3456)
4. Verify service (health check ensures proxy is responding)
5. Run action with ANTHROPIC_BASE_URL (Agent SDK routes through CCR)

**Why nohup**: Runs CCR service in background, detached from terminal

**Why sleep 5**: Gives service time to start before health check

**Why health check**: Ensures service is actually running before executing action (fail fast if service didn't start)

**Why upload logs on failure**: Debugging CCR service issues requires logs

**Environment variables**:

- Multi-provider API keys set during config generation
- ANTHROPIC_BASE_URL set during action execution (Agent SDK reads this)

**Note**: action.yml does NOT need api-key inputs anymore. API keys are passed as env vars to config generation, not to the action itself.
</action>
<verify>

```bash
# Verify CCR installation step
grep -q "npm install -g @musistudio/claude-code-router" .github/workflows/gsd-command-handler.yml && echo "CCR installation added"

# Verify config generation step
grep -q "npm run setup:ccr" .github/workflows/gsd-command-handler.yml && echo "Config generation added"

# Verify service start step
grep -q "ccr start" .github/workflows/gsd-command-handler.yml && echo "Service start added"

# Verify health check
grep -q "curl.*3456/health" .github/workflows/gsd-command-handler.yml && echo "Health check added"

# Verify ANTHROPIC_BASE_URL env var
grep -q "ANTHROPIC_BASE_URL.*127.0.0.1:3456" .github/workflows/gsd-command-handler.yml && echo "Base URL configured"

# Verify API keys in config generation step
grep -A5 "Generate CCR Configuration" .github/workflows/gsd-command-handler.yml | grep -q "OPENROUTER_API_KEY\|ANTHROPIC_API_KEY\|DEEPSEEK_API_KEY" && echo "API keys configured"

# Verify YAML syntax valid
node -e "require('js-yaml').load(require('fs').readFileSync('.github/workflows/gsd-command-handler.yml', 'utf8'))" && echo "YAML valid"
```

  </verify>
  <done>Workflow includes CCR service lifecycle (install, configure, start, verify), ANTHROPIC_BASE_URL environment variable, multi-provider API keys, log upload on failure, YAML syntax valid</done>
</task>

<task type="auto">
  <name>Rebuild with complete integration</name>
  <files>dist/index.js</files>
  <action>
Run build to verify complete integration (Agent SDK + config generator + wrapper + prompts) bundles successfully:

```bash
npm run build
```

Verify:

- Build completes without errors
- No circular dependency warnings
- dist/index.js updated with latest code
- File size remains reasonable (< 500KB)

**Why rebuild**: Ensures all new modules (src/llm/config-generator.js, src/llm/agent.js, src/llm/prompts.js) and imports in src/index.js bundle correctly. Catches module resolution issues before deployment.

**Note**: CCR service is NOT bundled (installed globally in workflow). Only Agent SDK client library and config generator are bundled.

If build succeeds, the bundled action is ready for end-to-end testing (next task).
</action>
<verify>

```bash
# Verify build succeeds
npm run build 2>&1 | tee build.log
grep -qi "error" build.log && echo "Build errors found" && exit 1 || echo "Build successful"

# Verify bundle updated
test -f dist/index.js && echo "Bundle exists"
stat -f%z dist/index.js  # Check file size

# Verify LLM modules bundled
grep -q "generateCCRConfig" dist/index.js && echo "Config generator bundled"
grep -q "executeLLMTask" dist/index.js && echo "Agent wrapper bundled"
grep -q "createMilestonePrompt" dist/index.js && echo "Prompts bundled"

# Verify Agent SDK bundled (not CCR service)
grep -q "anthropic.*sdk" dist/index.js && echo "Agent SDK bundled"
```

  </verify>
  <done>npm run build succeeds, dist/index.js updated with all LLM modules, no errors or circular dependencies, Agent SDK bundled (CCR service not bundled)</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete multi-provider LLM integration with CCR proxy service architecture:

**Service layer (installed globally in workflow)**:

- Claude Code Router @2.0.0 (proxy server on port 3456)
- Config generation with multi-provider support (OpenRouter, Anthropic, DeepSeek)
- NON_INTERACTIVE_MODE for CI safety

**Client layer (bundled in action)**:

- Anthropic Agent SDK (HTTP client library)
- Agent SDK wrapper with permissionMode: acceptEdits
- Prompt templates for GSD commands

**Workflow integration**:

- CCR service lifecycle management
- Multi-provider API key configuration
- ANTHROPIC_BASE_URL routing to CCR proxy
- Health checks and error logging

**Not yet executed**: No actual LLM calls in this phase. Command execution logic will be added in Phase 5 (Milestone Creation Workflow).
</what-built>

  <how-to-verify>
Verify the complete CCR integration is correctly configured:

**1. Check workflow CCR lifecycle**:

```bash
cat .github/workflows/gsd-command-handler.yml | grep -A5 "Install Claude Code Router"
# Expected: npm install -g @musistudio/claude-code-router@2.0.0

cat .github/workflows/gsd-command-handler.yml | grep -A10 "Generate CCR Configuration"
# Expected: All three API key env vars (OPENROUTER, ANTHROPIC, DEEPSEEK)

cat .github/workflows/gsd-command-handler.yml | grep -A5 "Start CCR Service"
# Expected: nohup ccr start, sleep 5, health check curl

cat .github/workflows/gsd-command-handler.yml | grep "ANTHROPIC_BASE_URL"
# Expected: http://127.0.0.1:3456
```

**2. Check package.json setup script**:

```bash
cat package.json | grep "setup:ccr"
# Expected: Script that calls generateCCRConfig()
```

**3. Check bundle includes client library (not service)**:

```bash
grep -c "anthropic.*sdk" dist/index.js
# Expected: > 0 (Agent SDK is bundled)

grep -c "generateCCRConfig" dist/index.js
# Expected: > 0 (Config generator is bundled)

# CCR service should NOT be in bundle (it's installed globally)
grep -c "@musistudio/claude-code-router" dist/index.js || echo "CCR service not bundled (correct)"
# Expected: 0 or not found (CCR is not bundled)
```

**4. Check config generator creates correct structure**:

```bash
cat src/llm/config-generator.js | grep '"NON_INTERACTIVE_MODE"'
# Expected: true (prevents CI hangs)

cat src/llm/config-generator.js | grep '"Providers"'
# Expected: Array with openrouter, anthropic, deepseek

cat src/llm/config-generator.js | grep '\$.*API_KEY'
# Expected: $OPENROUTER_API_KEY, $ANTHROPIC_API_KEY, $DEEPSEEK_API_KEY (env var syntax)
```

**5. Check Agent SDK wrapper routing**:

```bash
cat src/llm/agent.js | grep "import.*query.*from.*claude-agent-sdk"
# Expected: Import statement for SDK query function

cat src/llm/agent.js | grep "permissionMode.*acceptEdits"
# Expected: Non-interactive mode configuration
```

**Expected outcomes** (pass/fail criteria):

- PASS: Workflow installs CCR globally (@2.0.0)
- PASS: Config generation runs before service start with all API keys
- PASS: Service starts with nohup + health check
- PASS: ANTHROPIC_BASE_URL set to http://127.0.0.1:3456
- PASS: Bundle contains Agent SDK and config generator
- PASS: Config uses $VAR_NAME syntax for env interpolation
- PASS: NON_INTERACTIVE_MODE set to true
- PASS: permissionMode: acceptEdits in Agent SDK wrapper
- FAIL: CCR service bundled in dist/index.js (should be global install only)
- FAIL: Missing health check or service verification

**User setup required** (document in README):
The user must configure at least ONE of these GitHub Secrets:

- `OPENROUTER_API_KEY` (primary, recommended - access to 400+ models)
- `ANTHROPIC_API_KEY` (fallback, direct Claude access)
- `DEEPSEEK_API_KEY` (fallback, cost optimization)

Go to: Repository Settings → Secrets and variables → Actions → New repository secret

**Provider selection priority**:

1. OpenRouter (default) - Multi-model access via single API
2. DeepSeek (think scenario) - Reasoning tasks
3. Anthropic (fallback) - Direct Claude API if others unavailable
   </how-to-verify>

  <resume-signal>
Type "approved" if configuration verified, or describe any issues found.
  </resume-signal>
</task>

</tasks>

<verification>
Phase 3 complete when:
- package.json includes setup:ccr script
- Workflow includes CCR service lifecycle (install, configure, start, verify)
- ANTHROPIC_BASE_URL environment variable configured
- Multi-provider API keys passed to config generation
- Build succeeds with Agent SDK and config generator bundled
- Human verification confirms service architecture correctness
- No execution logic added yet (deferred to Phase 5)
</verification>

<success_criteria>
**All Phase 3 requirements satisfied**:

- CCR-01: CCR service installed and Agent SDK bundled ✓
- CCR-02: Both CCR and Agent SDK versions pinned ✓
- CCR-03: Config generated at ~/.claude-code-router/config.json via setup script ✓
- CCR-04: API keys interpolated via $VAR_NAME syntax, CCR reads from env ✓
- CCR-05: Agent SDK wrapper routes through CCR when ANTHROPIC_BASE_URL set ✓
- CCR-06: CCR installed via npm global, Agent SDK via package manager ✓
- CCR-07: NON_INTERACTIVE_MODE in config + permissionMode: acceptEdits in SDK ✓

**Observable behaviors**:

1. Workflow installs CCR globally before action execution
2. Config generation creates multi-provider setup
3. CCR service starts and passes health check
4. Agent SDK routes to CCR via ANTHROPIC_BASE_URL
5. Non-interactive mode guaranteed (no prompts possible)

**Files modified**:

- package.json: Added setup:ccr script
- .github/workflows/gsd-command-handler.yml: Added CCR service lifecycle

**Ready for Phase 4**: LLM integration infrastructure complete with CCR proxy service and multi-provider routing. Phase 4 (GitHub Integration & Response) will implement GitHub CLI operations. Phase 5 (Milestone Creation Workflow) will use executeLLMTask to implement gsd:new-milestone command with provider routing through CCR.

**Security note**: User must add at least ONE GitHub Secret (OPENROUTER_API_KEY, ANTHROPIC_API_KEY, or DEEPSEEK_API_KEY). Config generator will error if none are present. This is user setup, not automated by this action.

**Architecture summary**:

```
GitHub Actions Workflow
  ↓
1. Install CCR globally (npm install -g @musistudio/claude-code-router@2.0.0)
  ↓
2. Generate config (npm run setup:ccr → creates ~/.claude-code-router/config.json)
  ↓
3. Start CCR service (ccr start → proxy on port 3456)
  ↓
4. Set ANTHROPIC_BASE_URL=http://127.0.0.1:3456
  ↓
5. Run action (Agent SDK routes through CCR to configured providers)
```

</success_criteria>

<output>
After completion, create `.planning/phases/03-ccr-integration/03-03-SUMMARY.md` with:
- Performance metrics
- CCR service lifecycle verification results
- Service architecture diagram (workflow → CCR service → providers)
- User setup requirements (GitHub Secrets configuration)
- Provider selection priority and routing
- Health check and error logging details
- Any deviations from plan
- Readiness for Phase 4 and Phase 5
</output>
