---
phase: 10-test-infrastructure
plan: 07
type: execute
wave: 4
depends_on: ["10-05", "10-06"]
files_modified:
  - package.json
  - .github/workflows/test.yml
autonomous: true

must_haves:
  truths:
    - "npm test runs successfully with all tests passing"
    - "npm run test:coverage meets 80% threshold"
    - "CI workflow runs tests on push and PR"
  artifacts:
    - path: ".github/workflows/test.yml"
      provides: "GitHub Actions workflow for automated testing"
      contains: "vitest"
    - path: "package.json"
      provides: "Updated test scripts"
      contains: "test:ci"
  key_links:
    - from: ".github/workflows/test.yml"
      to: "npm test"
      via: "CI command"
      pattern: "npm.*test"
---

<objective>
Finalize test suite and add CI integration for automated testing.

Purpose: Ensure all tests pass, coverage thresholds are met, and tests run automatically on every push and pull request.

Output: Complete test suite with CI workflow and verified coverage.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/10-test-for-each-service-method-feature-and-flow/10-RESEARCH.md
@.planning/phases/10-test-for-each-service-method-feature-and-flow/10-05-SUMMARY.md
@.planning/phases/10-test-for-each-service-method-feature-and-flow/10-06-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Run full test suite and fix any failures</name>
  <files>Various test files</files>
  <action>
  1. Run complete test suite:
     ```
     npm test -- --run
     ```

2. If any tests fail, investigate and fix:
   - Check mock setup is correct
   - Verify imports match actual module exports
   - Fix any ESM hoisting issues
   - Ensure async/await used correctly

3. Run coverage report:

   ```
   npm run test:coverage
   ```

4. Review coverage output:
   - Overall coverage should be >80%
   - Critical modules (auth, parser, validator) should be >90%
   - Note any uncovered lines and consider if they need tests

5. If coverage below threshold, add targeted tests for uncovered paths

This task is iterative - repeat until all tests pass and coverage meets thresholds.
</action>
<verify>Run `npm test -- --run` - all tests pass (0 failures)</verify>
<done>Full test suite passes with coverage meeting 80% threshold</done>
</task>

<task type="auto">
  <name>Task 2: Add CI test scripts to package.json</name>
  <files>package.json</files>
  <action>
  Update package.json scripts to include CI-specific test command:

```json
{
  "scripts": {
    "test": "vitest",
    "test:run": "vitest run",
    "test:coverage": "vitest --coverage",
    "test:ci": "vitest run --coverage --reporter=verbose"
  }
}
```

The `test:ci` script:

- Uses `run` to execute once (not watch mode)
- Includes `--coverage` for CI reporting
- Uses `--reporter=verbose` for detailed output in CI logs

Verify scripts work:

```
npm run test:ci
```

  </action>
  <verify>Run `npm run test:ci` - executes tests with coverage output</verify>
  <done>CI-specific test script added to package.json</done>
</task>

<task type="auto">
  <name>Task 3: Create GitHub Actions test workflow</name>
  <files>.github/workflows/test.yml</files>
  <action>
  Create .github/workflows/test.yml for automated testing:

```yaml
name: Test Suite

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Run tests
        run: npm run test:ci

      - name: Upload coverage report
        uses: codecov/codecov-action@v4
        if: always()
        with:
          files: ./coverage/lcov.info
          fail_ci_if_error: false
        continue-on-error: true
```

Key aspects:

- **Node.js 20** matches action.yml (`runs.using: 'node20'`) - VERIFIED
- **cache-dependency-path: package-lock.json** - REQUIRED for npm caching to work
  (Without this, GitHub Actions fails with "Some specified paths were not resolved")
- npm ci for clean install
- test:ci script for coverage
- Codecov upload with proper error handling:
  - fail_ci_if_error: false prevents CI failure if codecov service is down
  - continue-on-error: true prevents job failure if no codecov token configured
- Runs on push to main and all PRs

**VALIDATION BEFORE COMMIT:**
After creating test.yml, validate locally:

```bash
# If actionlint is installed:
actionlint .github/workflows/test.yml

# Or use npx:
npx actionlint .github/workflows/test.yml
```

NOTE: If you want codecov reporting to work properly, the repository needs
CODECOV_TOKEN secret configured. Without it, coverage will still run locally
but upload will silently skip in CI.
</action>
<verify>Check workflow syntax: `cat .github/workflows/test.yml` - valid YAML</verify>
<done>CI workflow created for automated testing on push and PR</done>
</task>

</tasks>

<verification>
1. `npm test -- --run` passes all tests
2. `npm run test:coverage` shows >80% overall coverage
3. `npm run test:ci` runs successfully
4. .github/workflows/test.yml is valid YAML
5. Test workflow triggers on push to main and PRs
</verification>

<success_criteria>

- All tests pass (0 failures)
- Coverage meets 80% minimum threshold
- test:ci script works for CI environment
- GitHub Actions workflow created with proper cache configuration
- Tests will run automatically on every push and PR
  </success_criteria>

<output>
After completion, create `.planning/phases/10-test-for-each-service-method-feature-and-flow/10-07-SUMMARY.md`
</output>
