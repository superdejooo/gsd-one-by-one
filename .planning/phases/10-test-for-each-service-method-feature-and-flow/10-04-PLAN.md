---
phase: 10-test-infrastructure
plan: 04
type: execute
wave: 2
depends_on: ["10-01"]
files_modified:
  - src/git/git.test.js
  - src/git/branches.test.js
  - src/milestone/phase-planner.test.js
  - src/milestone/phase-executor.test.js
autonomous: true

must_haves:
  truths:
    - "Git operations tested with mocked child_process"
    - "Phase number parsing tested for all formats"
    - "CCR command execution tested with mocked exec"
    - "Output parsing tested with sample GSD outputs"
  artifacts:
    - path: "src/git/git.test.js"
      provides: "Tests for runGitCommand, configureGitIdentity, createAndSwitchBranch, switchBranch"
      min_lines: 60
    - path: "src/git/branches.test.js"
      provides: "Extended tests for createMilestoneBranch, createPhaseBranch, branchExists"
      min_lines: 50
    - path: "src/milestone/phase-planner.test.js"
      provides: "Tests for parsePhaseNumber and executePhaseWorkflow"
      min_lines: 80
    - path: "src/milestone/phase-executor.test.js"
      provides: "Tests for parsePhaseNumber, parseExecutionOutput, formatExecutionComment, executePhaseExecutionWorkflow"
      min_lines: 100
  key_links:
    - from: "src/git/git.test.js"
      to: "node:child_process"
      via: "vi.mock()"
      pattern: "vi.mock.*child_process"
---

<objective>
Create tests for modules that execute shell commands via child_process.

Purpose: Verify git operations and CCR command execution work correctly by mocking child_process.exec with various success/failure scenarios.

Output: Test files covering git.js, branches.js (git ops), phase-planner.js, and phase-executor.js.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/10-test-for-each-service-method-feature-and-flow/10-RESEARCH.md
@.planning/phases/10-test-for-each-service-method-feature-and-flow/10-01-SUMMARY.md
@src/git/git.js
@src/git/branches.js
@src/milestone/phase-planner.js
@src/milestone/phase-executor.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create git.js tests with child_process mocking</name>
  <files>src/git/git.test.js</files>
  <action>
  Create tests for git command execution. Key pattern for mocking promisify + exec:

  ```javascript
  import { describe, it, expect, vi, beforeEach } from 'vitest';

  // Mock child_process exec
  const mockExec = vi.fn();
  vi.mock('node:child_process', () => ({
    exec: mockExec
  }));

  // Mock util.promisify to return our controlled async function
  vi.mock('node:util', async () => {
    const actual = await vi.importActual('node:util');
    return {
      ...actual,
      promisify: () => async (command) => {
        return new Promise((resolve, reject) => {
          // Use the mockExec to control behavior
          const result = mockExec(command);
          if (result instanceof Error) {
            reject(result);
          } else {
            resolve(result || { stdout: '', stderr: '' });
          }
        });
      }
    };
  });

  // Mock @actions/core
  vi.mock('@actions/core', () => ({
    debug: vi.fn(),
    info: vi.fn(),
    warning: vi.fn(),
    error: vi.fn()
  }));
  ```

  **runGitCommand tests:**
  - Returns stdout trimmed on success
  - Logs warning when stderr has content
  - Throws error when command fails
  - Logs command being executed (debug)

  **configureGitIdentity tests:**
  - Runs git config for user.name
  - Runs git config for user.email
  - Logs success message

  **createAndSwitchBranch tests:**
  - Runs git switch -c {branchName}
  - Includes startPoint when provided
  - Logs branch creation

  **switchBranch tests:**
  - Runs git switch {branchName}
  - Logs branch switch
  </action>
  <verify>Run `npm test -- src/git/git.test.js --run` - all tests pass</verify>
  <done>Git command execution tested with mocked child_process</done>
</task>

<task type="auto">
  <name>Task 2: Extend branches.test.js with git operation tests</name>
  <files>src/git/branches.test.js</files>
  <action>
  Extend the existing branches.test.js (which already has slugify tests from Plan 02) to include git operations.

  Add to existing file after slugify tests:

  ```javascript
  // Additional mocking for git operations
  vi.mock('./git.js', () => ({
    createAndSwitchBranch: vi.fn(),
    switchBranch: vi.fn(),
    runGitCommand: vi.fn()
  }));

  vi.mock('@actions/core', () => ({
    info: vi.fn()
  }));
  ```

  **createMilestoneBranch tests:**
  - Creates branch named gsd/{milestoneNumber}
  - Calls createAndSwitchBranch with correct name
  - Logs milestone branch creation

  **createPhaseBranch tests:**
  - Creates branch named gsd/{milestone}-{phase}-{slug}
  - Uses slugify for phase name
  - Includes startPoint when provided
  - Logs phase branch creation

  **branchExists tests:**
  - Returns true when git rev-parse succeeds
  - Returns false when git rev-parse throws (branch not found)
  - Does not throw on missing branch

  Since branches.js imports from git.js, mock git.js functions rather than child_process directly.
  </action>
  <verify>Run `npm test -- src/git/branches.test.js --run` - all tests pass including new git op tests</verify>
  <done>Branch operations tested with mocked git.js functions</done>
</task>

<task type="auto">
  <name>Task 3: Create phase-planner.js and phase-executor.js tests</name>
  <files>src/milestone/phase-planner.test.js, src/milestone/phase-executor.test.js</files>
  <action>
  **phase-planner.test.js:**

  ```javascript
  import { describe, it, expect, vi, beforeEach } from 'vitest';

  // Mock child_process
  const mockExecAsync = vi.fn();
  vi.mock('child_process', () => ({
    exec: vi.fn()
  }));
  vi.mock('util', () => ({
    promisify: () => mockExecAsync
  }));

  // Mock fs/promises
  vi.mock('fs/promises', () => ({
    default: {
      readFile: vi.fn(),
      unlink: vi.fn()
    }
  }));

  // Mock github.js
  vi.mock('../lib/github.js', () => ({
    postComment: vi.fn(),
    getWorkflowRunUrl: vi.fn(() => 'https://example.com/run/123')
  }));

  // Mock formatter
  vi.mock('../errors/formatter.js', () => ({
    formatErrorComment: vi.fn((err) => `Error: ${err.message}`)
  }));

  // Mock @actions/core
  vi.mock('@actions/core', () => ({
    info: vi.fn(),
    warning: vi.fn(),
    error: vi.fn()
  }));
  ```

  **parsePhaseNumber tests:**
  - Parses "--phase 7"
  - Parses "--phase=7"
  - Parses "-p 7"
  - Parses "-p=7"
  - Parses standalone "7"
  - Throws for empty string
  - Throws for non-numeric input

  **executePhaseWorkflow tests (integration):**
  - Executes CCR command with correct phase number
  - Posts output to GitHub on success
  - Posts error comment on failure
  - Handles command timeout
  - Cleans up output file

  **phase-executor.test.js:**

  Same mock setup as phase-planner, plus:

  **parseExecutionOutput tests (internal function - test via module):**
  Create test cases with sample GSD output:
  ```
  - [x] Task 1 completed
  - [x] Task 2 completed

  Next steps:
  - Step 1
  - Step 2

  Questions:
  - What color should button be?
  ```

  - Extracts completed actions from [x] markers
  - Extracts next steps section
  - Extracts questions section
  - Sets hasQuestions when questions present
  - Handles output without sections gracefully

  **formatExecutionComment tests:**
  - Includes completed actions
  - Includes next steps
  - Includes questions with reply prompt
  - Includes raw output in details section

  **executePhaseExecutionWorkflow tests:**
  - Uses 30-minute timeout (vs 10 min for planner)
  - Returns hasQuestions flag
  - Returns completedCount
  - Posts structured comment (not raw output)
  </action>
  <verify>Run `npm test -- src/milestone/phase-planner.test.js src/milestone/phase-executor.test.js --run` - all tests pass</verify>
  <done>Phase planner and executor tested with mocked exec and output parsing</done>
</task>

</tasks>

<verification>
1. `npm test -- --run` runs all child_process-dependent tests
2. Git operations tested without actual git commands
3. CCR command execution tested without real LLM calls
4. Output parsing verified with representative GSD output samples
5. Coverage shows >80% for git.js, branches.js, phase-planner.js, phase-executor.js
</verification>

<success_criteria>
- 4 test files created/extended for child_process modules
- promisify + exec mocking pattern works correctly
- parsePhaseNumber tested for all input formats
- Output parsing tested with real-world GSD output patterns
- Timeout values verified (10 min planner, 30 min executor)
- All tests pass on `npm test -- --run`
</success_criteria>

<output>
After completion, create `.planning/phases/10-test-for-each-service-method-feature-and-flow/10-04-SUMMARY.md`
</output>
