---
phase: 10-test-infrastructure
plan: 03
type: execute
wave: 2
depends_on: ["10-01"]
files_modified:
  - src/auth/validator.test.js
  - src/lib/labels.test.js
  - src/lib/projects.test.js
  - src/lib/github.test.js
autonomous: true

must_haves:
  truths:
    - "GitHub API modules tested with mocked Octokit"
    - "All permission levels tested for authorization"
    - "GraphQL queries tested for Projects v2"
    - "Error handling (404, 422) tested"
  artifacts:
    - path: "src/auth/validator.test.js"
      provides: "Tests for hasWriteAccess, checkAuthorization, getAuthContext"
      min_lines: 80
    - path: "src/lib/labels.test.js"
      provides: "Tests for ensureLabelsExist, applyLabels, updateIssueStatus"
      min_lines: 70
    - path: "src/lib/projects.test.js"
      provides: "Tests for getProject, getIterations, findIteration"
      min_lines: 60
    - path: "src/lib/github.test.js"
      provides: "Tests for postComment, getWorkflowRunUrl"
      min_lines: 40
  key_links:
    - from: "src/auth/validator.test.js"
      to: "octokit.rest.repos.getCollaboratorPermissionLevel"
      via: "mocked Octokit"
      pattern: "mockResolvedValue"
---

<objective>
Create tests for all modules that interact with GitHub's REST and GraphQL APIs.

Purpose: Verify correct handling of GitHub API responses, error conditions (404 not found, 422 already exists), and permission levels without making real API calls.

Output: Test files with mocked Octokit covering authorization, labels, projects, and core GitHub operations.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/10-test-for-each-service-method-feature-and-flow/10-RESEARCH.md
@.planning/phases/10-test-for-each-service-method-feature-and-flow/10-01-SUMMARY.md
@src/auth/validator.js
@src/lib/labels.js
@src/lib/projects.js
@src/lib/github.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create auth/validator.js tests with Octokit mocking</name>
  <files>src/auth/validator.test.js</files>
  <action>
  Create comprehensive tests for authorization module. This module uses @actions/github context and Octokit REST API.

**Mock setup pattern:**

```javascript
import { describe, it, expect, vi, beforeEach } from "vitest";
import * as github from "@actions/github";

// Mock @actions/github module
vi.mock("@actions/github", () => ({
  context: {
    repo: { owner: "test-owner", repo: "test-repo" },
    payload: {
      sender: { login: "test-user" },
      issue: { number: 123 },
      comment: { id: 456 },
    },
  },
}));
```

**hasWriteAccess tests:**

- Returns true for 'admin' permission
- Returns true for 'write' permission
- Returns true for 'maintain' permission
- Returns false for 'read' permission
- Returns false for 'triage' permission
- Returns false when 404 (not a collaborator)
- Throws for non-404 errors

Create mock octokit for each test:

```javascript
const mockOctokit = {
  rest: {
    repos: {
      getCollaboratorPermissionLevel: vi.fn(),
    },
  },
};
```

**getAuthContext tests:**

- Returns username from payload.sender.login
- Returns owner and repo from context
- Returns issueNumber from payload.issue
- Sets isComment based on comment.id presence

**checkAuthorization tests:**

- Returns authorized: true for admin users
- Returns authorized: true for write users
- Returns authorized: false for read users
- Returns authorized: false with reason when 404
- Returns authorized: false when no sender in payload
- Includes permission and roleName in result
  </action>
  <verify>Run `npm test -- src/auth/validator.test.js --run` - all tests pass</verify>
  <done>Authorization module tested with all permission levels and error conditions</done>
  </task>

<task type="auto">
  <name>Task 2: Create labels.js and github.js tests</name>
  <files>src/lib/labels.test.js, src/lib/github.test.js</files>
  <action>
  **labels.test.js** - Mock the octokit import from github.js:

```javascript
import { describe, it, expect, vi, beforeEach } from "vitest";

// Create mock octokit
const mockOctokit = {
  rest: {
    issues: {
      listLabelsForRepo: vi.fn(),
      createLabel: vi.fn(),
      addLabels: vi.fn(),
      listLabelsOnIssue: vi.fn(),
      setLabels: vi.fn(),
    },
  },
};

// Mock the github.js module that exports octokit
vi.mock("./github.js", () => ({
  octokit: mockOctokit,
}));

// Mock @actions/core
vi.mock("@actions/core", () => ({
  info: vi.fn(),
}));
```

**STATUS_LABELS tests:**

- Contains 4 status labels
- Each has name, color, description

**ensureLabelsExist tests:**

- Creates missing labels
- Skips existing labels
- Handles 422 error gracefully (race condition)
- Throws on non-422 errors

**applyLabels tests:**

- Calls addLabels with correct params
- Logs applied labels

**updateIssueStatus tests:**

- Throws for invalid status
- Accepts valid statuses: pending, in-progress, complete, blocked
- Removes existing status labels
- Keeps non-status labels
- Sets new status label atomically

**github.test.js** - Test postComment and getWorkflowRunUrl:

```javascript
vi.mock("@actions/core", () => ({
  getInput: vi.fn(() => "mock-token"),
  info: vi.fn(),
}));

vi.mock("@actions/github", () => ({
  getOctokit: vi.fn(() => mockOctokit),
  context: {
    token: "mock-token",
    server_url: "https://github.com",
    repository: "owner/repo",
    run_id: "12345",
    run_attempt: "1",
  },
}));
```

**postComment tests:**

- Calls createComment with owner, repo, issue_number, body
- Logs success message

**getWorkflowRunUrl tests:**

- Returns correct URL format
- Includes server_url, repository, run_id, run_attempt
  </action>
  <verify>Run `npm test -- src/lib/labels.test.js src/lib/github.test.js --run` - all tests pass</verify>
  <done>Labels and GitHub core module tested with mocked Octokit</done>
  </task>

<task type="auto">
  <name>Task 3: Create projects.js tests with GraphQL mocking</name>
  <files>src/lib/projects.test.js</files>
  <action>
  **projects.test.js** - Mock Octokit GraphQL:

```javascript
import { describe, it, expect, vi, beforeEach } from "vitest";

const mockOctokit = {
  graphql: vi.fn(),
};

vi.mock("./github.js", () => ({
  octokit: mockOctokit,
}));

vi.mock("@actions/core", () => ({
  info: vi.fn(),
  warning: vi.fn(),
  error: vi.fn(),
}));
```

**getProject tests:**

- Returns project for organization (isOrg: true)
- Returns project for user (isOrg: false)
- Returns null when project not found
- Returns null on 404 error
- Returns null on 403 error (no permission)
- Logs warning for not found

Mock GraphQL response:

```javascript
mockOctokit.graphql.mockResolvedValue({
  organization: {
    projectV2: {
      id: "proj_123",
      title: "Test Project",
      url: "https://github.com/orgs/test/projects/1",
    },
  },
});
```

**getIterations tests:**

- Returns iterations array from project
- Returns empty array when no iteration field
- Returns empty array on GraphQL error
- Logs iteration count

**findIteration tests:**

- Finds iteration by title (case-insensitive match)
- Returns null when project not found
- Returns null when iteration not found
- Logs found/not found status
  </action>
  <verify>Run `npm test -- src/lib/projects.test.js --run` - all tests pass</verify>
  <done>Projects GraphQL module tested with mocked responses</done>
  </task>

</tasks>

<verification>
1. `npm test -- --run` runs all GitHub API tests
2. All mock patterns follow vitest-fetch-mock and vi.mock() conventions
3. Error conditions tested: 404, 403, 422
4. Permission levels tested: admin, write, maintain, read, triage
5. Coverage shows >80% for all API modules
</verification>

<success_criteria>

- 4 test files created for GitHub API modules
- Octokit REST API mocked properly (rest.repos, rest.issues)
- Octokit GraphQL mocked for Projects v2
- @actions/github context mocked
- Error handling verified (404, 422 graceful handling)
- All tests pass on `npm test -- --run`
  </success_criteria>

<output>
After completion, create `.planning/phases/10-test-for-each-service-method-feature-and-flow/10-03-SUMMARY.md`
</output>
