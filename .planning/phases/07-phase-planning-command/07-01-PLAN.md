---
phase: "07-phase-planning-command"
plan: "01"
type: "execute"
wave: 1
depends_on: []
files_modified:
  - "src/lib/validator.js"
  - "src/index.js"
  - "src/milestone/phase-planner.js"
autonomous: true
must_haves:
  truths:
    - "GitHub Action recognizes 'plan-phase' command"
    - "CCR executes GSD plan-phase command"
    - "Output is captured and posted to GitHub"
  artifacts:
    - path: "src/lib/validator.js"
      provides: "ALLOWLIST includes 'plan-phase'"
    - path: "src/index.js"
      provides: "Dispatch for plan-phase command"
    - path: "src/milestone/phase-planner.js"
      provides: "executePhaseWorkflow: runs CCR, captures output, posts comment"
  key_links:
    - from: "src/lib/validator.js"
      to: "src/milestone/phase-planner.js"
      via: "command passes validation"
    - from: "src/index.js"
      to: "src/milestone/phase-planner.js"
      via: "executePhaseWorkflow call"
    - from: "src/milestone/phase-planner.js"
      to: "CCR via exec()"
      via: "echo '/gsd:plan-phase N' | ccr code --print > output.txt"
---

<objective>
Wire GSD's built-in plan-phase command into the GitHub Action.

The flow:
1. User comments: `@gsd-bot plan-phase 7`
2. Action validates command, runs CCR
3. CCR executes GSD: `echo "/gsd:plan-phase 7" | ccr code --print > output.txt`
4. Action waits for exit, reads output.txt
5. Action validates for errors, posts result to GitHub
</objective>

<context>
@src/index.js
@src/lib/validator.js
@src/milestone/index.js
@src/lib/github.js
@.planning/phases/07-phase-planning-command/07-RESEARCH-GSD.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add plan-phase to ALLOWLIST</name>
  <files>src/lib/validator.js</files>
  <action>
    Add "plan-phase" to the ALLOWED_COMMANDS array in src/lib/validator.js.

    Current line 7: `const ALLOWED_COMMANDS = ["new-milestone"];`

    Change to: `const ALLOWED_COMMANDS = ["new-milestone", "plan-phase"];`

    Keep existing validateCommand and sanitizeArguments functions.
  </action>
  <verify>grep -n 'ALLOWED_COMMANDS' src/lib/validator.js | grep -q '"plan-phase"'</verify>
  <done>Command allowlist includes "plan-phase"</done>
</task>

<task type="auto">
  <name>Task 2: Create phase-planner.js module</name>
  <files>src/milestone/phase-planner.js</files>
  <action>
    Create src/milestone/phase-planner.js with the following:

    **Exports:**
    - `parsePhaseNumber(commandArgs)` — Extracts phase number (7, --phase 7, or -p 7)
    - `executePhaseWorkflow(context, commandArgs)` — Main orchestrator

    **parsePhaseNumber:**
    ```javascript
    export function parsePhaseNumber(commandArgs) {
      // Try --phase N or --phase=N
      const phaseFlagMatch = commandArgs.match(/--phase[=\s]+(\d+)/);
      if (phaseFlagMatch) return parseInt(phaseFlagMatch[1], 10);

      // Try -p N or -p=N
      const pFlagMatch = commandArgs.match(/-p[=\s]+(\d+)/);
      if (pFlagMatch) return parseInt(pFlagMatch[1], 10);

      // Try standalone number at end
      const standaloneMatch = commandArgs.match(/(\d+)$/);
      if (standaloneMatch) return parseInt(standaloneMatch[1], 10);

      throw new Error("Phase number required: use --phase N, -p N, or just the number");
    }
    ```

    **executePhaseWorkflow:**
    ```javascript
    import * as core from "@actions/core";
    import * as github from "@actions/github";
    import { exec } from "child_process";
    import { promisify } from "util";
    import fs from "fs/promises";
    import { postComment } from "../lib/github.js";
    import { formatErrorComment } from "../errors/formatter.js";

    const execAsync = promisify(exec);

    export async function executePhaseWorkflow(context, commandArgs) {
      const { owner, repo, issueNumber } = context;

      // 1. Parse phase number
      const phaseNumber = parsePhaseNumber(commandArgs);
      core.info(`Parsed phase number: ${phaseNumber}`);

      // 2. Run GSD via CCR
      const outputPath = `output-${Date.now()}.txt`;
      const command = `echo "/gsd:plan-phase ${phaseNumber}" | ccr code --print > ${outputPath}`;

      core.info(`Executing: ${command}`);

      let exitCode = 0;
      try {
        await execAsync(command, { timeout: 600000 }); // 10 min timeout
      } catch (error) {
        exitCode = error.code || 1;
        core.warning(`Command exited with code ${exitCode}`);
      }

      // 3. Read captured output
      let output = "";
      try {
        output = await fs.readFile(outputPath, "utf-8");
      } catch (error) {
        output = "(No output captured)";
      }

      // 4. Validate for errors
      const isError = exitCode !== 0 ||
        /Permission Denied|Authorization failed|not authorized/i.test(output) ||
        /Error:|Something went wrong|failed/i.test(output) ||
        /Unknown command|invalid arguments|validation failed/i.test(output);

      // 5. Post result to GitHub
      if (isError) {
        const errorMsg = formatErrorComment(new Error(output.trim()), "phase planning");
        await postComment(owner, repo, issueNumber, errorMsg);
        throw new Error(`Phase planning failed: ${output.substring(0, 500)}`);
      }

      // Post success - pass through GSD output
      await postComment(owner, repo, issueNumber, output);

      // Cleanup
      try { await fs.unlink(outputPath); } catch (e) {}

      return { complete: true, phaseNumber };
    }
    ```
  </action>
  <verify>grep -q 'export { parsePhaseNumber, executePhaseWorkflow' src/milestone/phase-planner.js && grep -q 'execAsync' src/milestone/phase-planner.js</verify>
  <done>phase-planner.js exists with CCR execution flow</done>
</task>

<task type="auto">
  <name>Task 3: Update command dispatch in index.js</name>
  <files>src/index.js</files>
  <action>
    Add plan-phase dispatch to src/index.js.

    Add import after line 14:
    ```
    import { executePhaseWorkflow } from "./milestone/phase-planner.js";
    ```

    Add module trigger after line 23:
    ```
    const _phasePlannerModule = { executePhaseWorkflow };
    ```

    Add dispatch block after new-milestone dispatch (after line 96):
    ```javascript
    if (parsed.command === "plan-phase") {
      core.info("Dispatching to phase planning workflow");
      const result = await executePhaseWorkflow(
        { owner: repoOwner, repo: repoName, issueNumber: github.context.issue?.number },
        sanitizedArgs
      );
      core.setOutput("phase-planned", result.complete);
      core.setOutput("phase-number", result.phaseNumber);
      return { commandFound: true, command: parsed.command, ...result };
    }
    ```
  </action>
  <verify>grep -q 'executePhaseWorkflow' src/index.js && grep -q 'if (parsed.command === "plan-phase")' src/index.js</verify>
  <done>Command dispatch includes plan-phase handler</done>
</task>

</tasks>

<verification>
1. Test allowlist: `node -e "require('./src/lib/validator.js').validateCommand('plan-phase')"`
2. Module loads: `node -e "require('./src/milestone/phase-planner.js')"`
3. parsePhaseNumber tests: --phase 7, -p 7, standalone 7
4. executePhaseWorkflow called when plan-phase command dispatched
</verification>

<success_criteria>
- [ ] ALLOWLIST includes "plan-phase"
- [ ] src/milestone/phase-planner.js exists with parsePhaseNumber and executePhaseWorkflow
- [ ] executePhaseWorkflow runs CCR, captures output.txt, posts to GitHub
- [ ] index.js dispatches plan-phase to phase-planner
</success_criteria>
