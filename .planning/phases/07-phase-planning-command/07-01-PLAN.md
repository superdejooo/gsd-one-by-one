---
phase: "07-phase-planning-command"
plan: "01"
type: "execute"
wave: 1
depends_on: []
files_modified:
  - "src/lib/validator.js"
  - "src/index.js"
  - "src/milestone/phase-planner.js"
autonomous: true
must_haves:
  truths:
    - "Command 'plan-phase' is recognized and validated"
    - "Phase number is parsed from command arguments"
    - "Phase planner module exports required functions"
  artifacts:
    - path: "src/lib/validator.js"
      provides: "ALLOWLIST updated with 'plan-phase' command"
    - path: "src/index.js"
      provides: "Command dispatch for plan-phase workflow"
    - path: "src/milestone/phase-planner.js"
      provides: "parsePhaseNumber, executePhaseWorkflow, generatePhasePlanMarkdown, generatePhasePlanningSummary"
  key_links:
    - from: "src/lib/validator.js"
      to: "src/milestone/phase-planner.js"
      via: "command validation passes to workflow"
    - from: "src/index.js"
      to: "src/milestone/phase-planner.js"
      via: "executePhaseWorkflow call"
---

<objective>
Create the phase-planner.js module with all core functions and extend command dispatch to handle the `plan-phase` command.

This Wave 1 establishes the foundation:
- Add "plan-phase" to command allowlist in validator.js
- Extend command dispatch in index.js for plan-phase workflow
- Create phase-planner.js with parsePhaseNumber, executePhaseWorkflow, generatePhasePlanMarkdown, generatePhasePlanningSummary, groupTasksIntoWaves functions
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-phase-planning-command/07-RESEARCH.md
@src/index.js
@src/lib/validator.js
@src/milestone/index.js
@src/milestone/planning-docs.js
@src/milestone/state.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update command allowlist in validator.js</name>
  <files>src/lib/validator.js</files>
  <action>
    Add "plan-phase" to the ALLOWED_COMMANDS array in src/lib/validator.js.

    Current line 7: `const ALLOWED_COMMANDS = ["new-milestone"];`

    Change to: `const ALLOWED_COMMANDS = ["new-milestone", "plan-phase"];`

    Keep existing validateCommand and sanitizeArguments functions unchanged. The kebab-case validation will handle "plan-phase" format automatically.
  </action>
  <verify>grep -n 'ALLOWED_COMMANDS' src/lib/validator.js | grep -q '"plan-phase"'</verify>
  <done>Command allowlist includes "plan-phase"</done>
</task>

<task type="auto">
  <name>Task 2: Create phase-planner.js module</name>
  <files>src/milestone/phase-planner.js</files>
  <action>
    Create src/milestone/phase-planner.js with the following exports and functions:

    **Exports:**
    - `parsePhaseNumber(commandArgs)` - Extracts phase number from arguments
    - `executePhaseWorkflow(context, commandArgs)` - Main orchestrator
    - `generatePhasePlanMarkdown(phaseData, wave)` - Generates PLAN.md content
    - `generatePhasePlanningSummary(data)` - Generates completion summary
    - `groupTasksIntoWaves(tasks)` - Groups tasks by dependency level
    - `createPhaseState(phaseNumber, milestoneNumber)` - Creates phase state
    - `loadPhaseState(owner, repo, phaseNumber)` - Loads phase state
    - `savePhaseState(owner, repo, phaseNumber, state)` - Saves phase state

    **Key Implementation Details:**

    parsePhaseNumber: Follow the pattern from parseMilestoneNumber in src/milestone/index.js, supporting:
    - `--phase N` or `--phase=N`
    - `-p N` or `-p=N`
    - Standalone number at end of args

    executePhaseWorkflow: Orchestrates:
    1. Parse phase number from commandArgs
    2. Load milestone context from STATE.md and ROADMAP.md
    3. Generate phase plan data with wave grouping
    4. Create PLAN.md files in `.planning/phases/{n}/`
    5. Create phase branch and commit plan files
    6. Post summary comment

    generatePhasePlanMarkdown: Returns markdown with:
    - Phase number, milestone, wave in header
    - Goal and dependencies sections
    - Tasks table with ID, description, dependsOn, verification
    - Wave summary with parallelizable task count
    - Next steps section

    generatePhasePlanningSummary: Returns markdown with:
    - Phase planning complete header
    - Files created table
    - Next steps for user

    groupTasksIntoWaves: Implements the algorithm from 07-RESEARCH.md:
    - Tasks with no dependencies go in wave 1
    - Tasks whose deps are all in earlier waves go in next wave
    - Detect circular dependencies and throw error
  </action>
  <verify>grep -q 'export { parsePhaseNumber, executePhaseWorkflow' src/milestone/phase-planner.js && grep -q 'groupTasksIntoWaves' src/milestone/phase-planner.js</verify>
  <done>phase-planner.js exists with all required exports</done>
</task>

<task type="auto">
  <name>Task 3: Extend command dispatch in index.js</name>
  <files>src/index.js</files>
  <action>
    Extend src/index.js to dispatch `plan-phase` command to the phase planner workflow.

    Add imports at the top of the file (after line 14):
    ```
    import { executePhaseWorkflow as executePhaseWorkflowPlanner, parsePhaseNumber } from "./milestone/phase-planner.js";
    ```

    Update the module trigger comments (line 16-24) to include:
    ```
    const _phasePlannerModule = { executePhaseWorkflow: executePhaseWorkflowPlanner, parsePhaseNumber };
    ```

    Add dispatch block after the new-milestone dispatch (after line 96):
    ```javascript
    if (parsed.command === "plan-phase") {
      core.info("Dispatching to phase planning workflow");
      const result = await executePhaseWorkflowPlanner(
        { owner: repoOwner, repo: repoName, issueNumber: github.context.issue?.number },
        sanitizedArgs
      );
      core.info(`Phase planning workflow result: ${JSON.stringify(result)}`);
      core.setOutput("phase-planned", result.complete);
      core.setOutput("phase-number", result.phaseNumber);
      return { commandFound: true, command: parsed.command, ...result };
    }
    ```
  </action>
  <verify>grep -q 'executePhaseWorkflowPlanner' src/index.js && grep -q 'if (parsed.command === "plan-phase")' src/index.js</verify>
  <done>Command dispatch includes plan-phase handler</done>
</task>

</tasks>

<verification>
1. Command validation passes for "plan-phase": `node -e "require('./src/lib/validator.js').validateCommand('plan-phase')"` should not throw
2. Phase planner module loads without errors
3. Command dispatch recognizes plan-phase and calls executePhaseWorkflow
4. All functions are exported and callable
</verification>

<success_criteria>
- [ ] ALLOWLIST includes "plan-phase"
- [ ] src/milestone/phase-planner.js exists with 8 exports
- [ ] Command dispatch handles plan-phase in src/index.js
- [ ] Module triggers work (no import errors)
</success_criteria>

<output>
After completion, create `.planning/phases/07-phase-planning-command/07-01-SUMMARY.md`
</output>
