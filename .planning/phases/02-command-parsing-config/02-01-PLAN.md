---
phase: 02-command-parsing-config
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/parser.js
autonomous: true

must_haves:
  truths:
    - "Parser identifies @gsd-bot mention in comment body"
    - "Parser extracts command name (e.g., 'new-milestone') from mention"
    - "Parser returns null for comments without @gsd-bot mention"
    - "Parser handles case-insensitive matching (e.g., '@Gsd-Bot' works)"
    - "Parser normalizes commands to lowercase for consistent handling"
  artifacts:
    - path: "src/lib/parser.js"
      provides: "Comment parsing logic"
      exports: ["parseComment", "parseArguments"]
      min_lines: 60
  key_links:
    - from: "src/index.js"
      to: "src/lib/parser.js"
      via: "import parseComment, parseArguments"
      pattern: "import.*from.*parser"
---

<objective>
Implement complete parser module with comment parsing and argument extraction.

Purpose: Enable the action to identify @gsd-bot mentions, extract commands, and parse structured arguments (--key=value) from issue comments.

Output: src/lib/parser.js with parseComment and parseArguments functions
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/02-command-parsing-config/02-RESEARCH.md
@.planning/STATE.md

# Existing codebase

@src/index.js
@action.yml
</context>

<tasks>

<task type="auto">
  <name>Create complete parser module with parseComment and parseArguments</name>
  <files>src/lib/parser.js</files>
  <action>
Create src/lib/parser.js with the following implementation:

1. Add JSDoc comment at top:

```javascript
/**
 * Comment parsing for @gsd-bot commands
 *
 * Event Filtering:
 * - Created vs Edited: Already handled by workflow trigger (issue_comment: types: [created])
 * - No redundant event type checks needed in this code
 * - Workflow ensures only comment.created events trigger this action
 *
 * See: .github/workflows/gsd-command-handler.yml
 */

const BOT_MENTION = "@gsd-bot";
```

2. Export parseComment function:

```javascript
/**
 * Parse comment body to extract @gsd-bot command
 * @param {string} commentBody - Raw comment text
 * @returns {object|null} - { botMention, command, args } or null if not mentioned
 */
export function parseComment(commentBody) {
  // Trim whitespace and normalize line breaks
  const normalizedBody = commentBody
    .trim()
    .replace(/\r\n/g, " ")
    .replace(/\n/g, " ");

  // Check if bot is mentioned (case-insensitive)
  const normalizedForMention = normalizedBody.toLowerCase();
  if (!normalizedForMention.includes(BOT_MENTION.toLowerCase())) {
    return null;
  }

  // Extract command - pattern: @gsd-bot command-name [args...]
  const commandPattern = new RegExp(
    `${BOT_MENTION}\\s+(\\S+)(?:\\s+(.*))?$`,
    "i",
  );
  const match = normalizedBody.match(commandPattern);

  if (!match) {
    return null;
  }

  return {
    botMention: match[0],
    command: match[1].toLowerCase(), // Normalize to lowercase
    args: match[2] ? match[2].trim() : "",
  };
}
```

3. Export parseArguments function:

```javascript
/**
 * Parse command arguments in --key=value format
 * @param {string} argsString - Raw arguments string
 * @returns {object} - Key-value pairs
 */
export function parseArguments(argsString) {
  const args = {};
  const argPattern = /--(\w+)=("[^"]*"|'[^']*'|\S+)/g;
  let match;

  while ((match = argPattern.exec(argsString)) !== null) {
    const key = match[1];
    let value = match[2];

    // Remove quotes if present
    if (
      (value.startsWith('"') && value.endsWith('"')) ||
      (value.startsWith("'") && value.endsWith("'"))
    ) {
      value = value.slice(1, -1);
    }

    args[key] = value;
  }

  return args;
}
```

Patterns from RESEARCH.md - Pattern 1 (Command Mention Parsing) and Pattern 2 (Argument Parsing).

Why this structure:

- Case-insensitive matching allows '@Gsd-Bot', '@GSD-BOT', etc.
- Normalize to lowercase for consistent validation in later plans
- Args string passed to parseArguments
- Returns null when not mentioned to avoid processing irrelevant comments
- Simple regex for --key=value parsing, handles quotes
- Event filtering documented as workflow-level responsibility (PARS-04 satisfied)
  </action>
  <verify>
  cat src/lib/parser.js | grep -q "export.*parseComment" && cat src/lib/parser.js | grep -q "export.*parseArguments" && cat src/lib/parser.js | grep -q "BOT_MENTION" && cat src/lib/parser.js | grep -q "Event Filtering"
  </verify>
  <done>
  parser.js contains:
- JSDoc comment documenting event filtering strategy
- parseComment function that extracts command from @gsd-bot mention
- parseArguments function that parses --key=value format
- Both functions exported for use in index.js
- Handles case-insensitive matching
- Normalizes commands to lowercase
  </done>
  </task>

</tasks>

<verification>
After plan completion:
1. Check src/lib/parser.js exists with both functions
2. Verify parseComment handles:
   - "@gsd-bot new-milestone" returns command "new-milestone"
   - "@GSD-BOT NEW-MILESTONE" returns command "new-milestone"
   - "hello world" returns null
   - "@other-bot command" returns null
3. Verify parseArguments handles:
   - "--title=Feature" returns { title: "Feature" }
   - "--title=\"Feature X\"" returns { title: "Feature X" }
   - "" returns {}
4. Verify event filtering documentation present
</verification>

<success_criteria>

- src/lib/parser.js created with parseComment and parseArguments
- parseComment correctly identifies @gsd-bot mentions (case-insensitive)
- parseComment extracts command name and returns in lowercase
- parseComment returns null for comments without mention
- parseArguments parses --key=value format with quote handling
- Event filtering documented as workflow-level responsibility
  </success_criteria>

<output>
After completion, create `.planning/phases/02-command-parsing-config/02-01-SUMMARY.md`
</output>
