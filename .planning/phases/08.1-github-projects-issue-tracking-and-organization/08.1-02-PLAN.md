---
phase: 08.1-github-projects-issue-tracking-and-organization
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/projects.js
  - src/milestone/index.js
autonomous: true

must_haves:
  truths:
    - "Can query for GitHub Project by number"
    - "Can list iterations in a project"
    - "Can validate an iteration exists for a milestone"
    - "new-milestone warns if project iteration not found"
  artifacts:
    - path: "src/lib/projects.js"
      provides: "GitHub Projects v2 GraphQL queries (read-only)"
      exports: ["getProject", "getIterations", "findIteration"]
    - path: "src/milestone/index.js"
      provides: "Updated milestone workflow with iteration validation"
      contains: "validateProjectIteration"
  key_links:
    - from: "src/lib/projects.js"
      to: "src/lib/github.js"
      via: "imports octokit for GraphQL"
      pattern: "import.*octokit.*from.*github"
    - from: "src/milestone/index.js"
      to: "src/lib/projects.js"
      via: "imports findIteration"
      pattern: "import.*findIteration.*from.*projects"
---

<objective>
Create projects module for GitHub Projects v2 queries and integrate iteration validation into new-milestone workflow.

Purpose: Enable read-only queries to GitHub Projects for validation. new-milestone should verify a project iteration exists (user creates it manually per documentation). No iteration creation via API due to data loss risk.

Output: `src/lib/projects.js` with query functions, updated `src/milestone/index.js` with validation.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/08.1-github-projects-issue-tracking-and-organization/08.1-RESEARCH.md

# Existing codebase patterns

@src/lib/github.js
@src/milestone/index.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create projects.js module</name>
  <files>src/lib/projects.js</files>
  <action>
Create `src/lib/projects.js` with read-only GraphQL queries:

1. **getProject(owner, projectNumber, isOrg = true)** - Get project by number:
   - Use GraphQL query with `octokit.graphql()`
   - Support both organization projects (`organization(login: ...)`) and user projects (`user(login: ...)`)
   - Return `{ id, title, url }` or null if not found
   - Handle permission errors gracefully (return null with warning log)

GraphQL query pattern:

```graphql
query ($owner: String!, $number: Int!) {
  organization(login: $owner) {
    projectV2(number: $number) {
      id
      title
      url
    }
  }
}
```

2. **getIterations(projectId)** - List iterations for a project:
   - Query project fields to find iteration field
   - Extract iteration configuration
   - Return array of `{ id, title, startDate }` or empty array

GraphQL query pattern:

```graphql
query ($projectId: ID!) {
  node(id: $projectId) {
    ... on ProjectV2 {
      fields(first: 20) {
        nodes {
          ... on ProjectV2IterationField {
            id
            name
            configuration {
              iterations {
                id
                title
                startDate
              }
            }
          }
        }
      }
    }
  }
}
```

3. **findIteration(owner, projectNumber, iterationTitle, isOrg = true)** - Check if iteration exists:
   - Call getProject to get project ID
   - Call getIterations to list iterations
   - Find iteration by title (case-insensitive match)
   - Return iteration object if found, null otherwise
   - This is the main function milestone workflow will use

Import `octokit` from `./github.js` and `core` from `@actions/core`.

**CRITICAL:** These are read-only queries. Do NOT implement any mutation to create iterations - this causes data loss (see research doc).

Handle common errors:

- 404/403: Project not found or no permission (log warning, return null)
- GraphQL errors: Log and return null
  </action>
  <verify>
- File exists: `ls src/lib/projects.js`
- No syntax errors: `node --check src/lib/projects.js`
- Exports correct: `node -e "import('./src/lib/projects.js').then(m => console.log(Object.keys(m)))"`
- No mutation keywords: `grep -c "mutation" src/lib/projects.js` should be 0
  </verify>
  <done>
- getProject function queries for project by number
- getIterations function lists project iterations
- findIteration function validates iteration exists by title
- All functions are read-only (no mutations)
- Graceful error handling for permission issues
  </done>
  </task>

<task type="auto">
  <name>Task 2: Integrate iteration validation into new-milestone</name>
  <files>src/milestone/index.js</files>
  <action>
Update `src/milestone/index.js` to validate project iteration after milestone creation:

1. **Import findIteration** from `../lib/projects.js`

2. **Add validateProjectIteration helper function:**

```javascript
async function validateProjectIteration(owner, milestoneNumber, config) {
  // Check if project config exists
  const projectNumber = config?.project?.number;
  if (!projectNumber) {
    core.info("No project configured, skipping iteration validation");
    return { validated: false, reason: "no-project-configured" };
  }

  const isOrg = config?.project?.isOrg ?? true;
  const iterationTitle = `v${milestoneNumber}`; // Convention: v1, v2, etc.

  const iteration = await findIteration(
    owner,
    projectNumber,
    iterationTitle,
    isOrg,
  );

  if (iteration) {
    core.info(`Found project iteration: ${iteration.title}`);
    return { validated: true, iteration };
  } else {
    core.warning(
      `Project iteration "${iterationTitle}" not found. Create it manually in GitHub Projects.`,
    );
    return {
      validated: false,
      reason: "iteration-not-found",
      expected: iterationTitle,
      setupGuide: "See docs/project-setup.md for setup instructions",
    };
  }
}
```

3. **Call validation in executeMilestoneWorkflow:**
   - After Step 12 (post summary), before returning
   - Call `validateProjectIteration(owner, milestoneNumber, config)`
   - Include validation result in the return object
   - If iteration not found, append warning to next steps in summary

4. **Update the return object** to include:

```javascript
return {
  complete: true,
  phase: "milestone-created",
  milestone: milestoneNumber,
  files: fileList.map((f) => f.path),
  branch: `gsd/${milestoneNumber}`,
  projectIteration: validationResult, // NEW
  message: "Milestone created successfully with planning documents",
};
```

**Important:** This is validation only - do NOT attempt to create iterations. The warning message should guide users to the setup documentation.

5. **Load config for project settings:**
   - Use `loadConfig(owner, repo)` from `../lib/config.js` (already exists)
   - Config structure will include `project: { number: N, isOrg: boolean }`
     </action>
     <verify>

- Build succeeds: `npm run build`
- Import added: `grep "findIteration" src/milestone/index.js`
- Function exists: `grep "validateProjectIteration" src/milestone/index.js`
- No iteration creation: `grep -c "createIteration" src/milestone/index.js` should be 0
  </verify>
  <done>
- findIteration imported from projects.js
- validateProjectIteration helper function added
- executeMilestoneWorkflow calls validation after milestone creation
- Warning logged if iteration not found (not an error - graceful degradation)
- Return object includes projectIteration validation result
  </done>
  </task>

</tasks>

<verification>
1. `src/lib/projects.js` exists with 3 exports (getProject, getIterations, findIteration)
2. `src/milestone/index.js` imports and uses findIteration
3. `npm run build` succeeds
4. No mutation/creation code in projects.js
</verification>

<success_criteria>

- Projects module provides read-only GraphQL queries
- findIteration validates iteration exists by title
- new-milestone workflow validates project iteration after creation
- Graceful warning (not error) when iteration not found
- Build passes without errors
  </success_criteria>

<output>
After completion, create `.planning/phases/08.1-github-projects-issue-tracking-and-organization/08.1-02-SUMMARY.md`
</output>
