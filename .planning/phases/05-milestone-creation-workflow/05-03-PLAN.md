---
phase: 05-milestone-creation-workflow
plan: "03"
type: execute
wave: 1
depends_on: []
files_modified:
  - src/milestone/state.js
autonomous: true
user_setup: []

must_haves:
  truths:
    - "State file persists between workflow runs"
    - "Requirements gathering progress is tracked (answered vs pending questions)"
    - "Last processed comment ID is stored to identify new user responses"
  artifacts:
    - path: "src/milestone/state.js"
      provides: "State file management"
      exports: ["loadState", "saveState", "createInitialState", "isRequirementsComplete"]
  key_links:
    - from: "src/milestone/state.js"
      to: "src/milestone/planning-docs.js"
      via: "STATE.md file format compatibility"
      pattern: "generateStateMarkdown"
    - from: "src/milestone/state.js"
      to: "src/milestone/requirements.js"
      via: "question tracking"
      pattern: "requirements\\.(answered|pending)"
---

<objective>
Create the state management module that persists requirements gathering progress across multiple workflow runs using STATE.md files.

Purpose: Track which questions have been answered and maintain workflow metadata between workflow runs.
Output: src/milestone/state.js with loadState, saveState, and state helpers
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@/Users/dejan/00-code/00-ai-agents-skills-plugins/agent/.planning/phases/05-milestone-creation-workflow/05-RESEARCH.md
@/Users/dejan/00-code/00-ai-agents-skills-plugins/agent/src/milestone/planning-docs.js
</context>

<tasks>

<task type="auto">
  <name>Create src/milestone/state.js module</name>
  <files>src/milestone/state.js</files>
  <action>
Create the state management module with the following structure:

1. Import required modules:
   - * as github from "@actions/github"
   - * as core from "@actions/core"
   - Buffer from "node:buffer"

2. Define STATE_FILE path: `.github/planning/milestones/{n}/STATE.md`

3. Export createInitialState(milestoneNumber):
   - Returns state object with:
     - milestone: milestoneNumber
     - status: "requirements-gathering"
     - createdAt: ISO timestamp
     - requirements: { questions: [], answered: [], pending: [], complete: false }
     - workflow: { startedAt, lastRunAt: null, runCount: 0, lastCommentId: 0 }

4. Export loadState(owner, repo, milestoneNumber):
   - Try to fetch STATE.md via GitHub Contents API (octokit.rest.repos.getContent)
   - Decode base64 content using Buffer.from(content, "base64").toString("utf-8")
   - Parse state file content into object
   - Handle 404: return createInitialState(milestoneNumber)
   - Re-throw other errors

5. Export saveState(owner, repo, milestoneNumber, state):
   - Format state as markdown (for consistency with STATE.md format)
   - Encode to base64
   - Get existing file SHA if it exists
   - Use createOrUpdateFileContents to create/update
   - Include commit message with milestone number

6. Export isRequirementsComplete(state, questions):
   - Check all required questions have answers
   - Return boolean

7. Export updateRequirementsAnswer(state, questionId, answer):
   - Add to answered array, remove from pending
   - Update workflow.lastCommentId
  </action>
  <verify>
node --input-type=module -e "
import { loadState, saveState, createInitialState, isRequirementsComplete } from './src/milestone/state.js';
import { DEFAULT_QUESTIONS } from './src/milestone/requirements.js';

console.log('All exports available:', {
  loadState: typeof loadState === 'function',
  saveState: typeof saveState === 'function',
  createInitialState: typeof createInitialState === 'function',
  isRequirementsComplete: typeof isRequirementsComplete === 'function'
});

// Test createInitialState
const state = createInitialState(1);
console.log('Initial state created:', state.milestone === 1);
console.log('Status is requirements-gathering:', state.status === 'requirements-gathering');
console.log('Requirements structure:', state.requirements && Array.isArray(state.requirements.answered));

// Test isRequirementsComplete
const partialState = {
  ...state,
  requirements: { answered: ['scope'], pending: ['features', 'constraints', 'timeline'], complete: false }
};
const incomplete = isRequirementsComplete(partialState, DEFAULT_QUESTIONS);
console.log('Partial requirements incomplete:', incomplete === false);

const completeState = {
  ...state,
  requirements: { answered: ['scope', 'features'], pending: ['constraints', 'timeline'], complete: false }
};
const alsoIncomplete = isRequirementsComplete(completeState, DEFAULT_QUESTIONS);
console.log('Partial requirements still incomplete:', alsoIncomplete === false);
"
</verify>
  <done>
src/milestone/state.js exists with all required exports, and test output confirms initial state creation and requirements checking work correctly
</done>
</task>

<task type="auto">
  <name>Test state update and save operations</name>
  <files>src/milestone/state.js</files>
  <action>
Add and test state update functions:

1. Create a test that:
   - Generates initial state
   - Updates state with answers for questions
   - Verifies isRequirementsComplete returns true when all required questions answered
   - Verifies runCount increments correctly
   - Verifies lastCommentId is tracked

2. Mock the GitHub API interactions for saveState testing
  </action>
  <verify>
node --input-type=module -e "
import { createInitialState, isRequirementsComplete } from './src/milestone/state.js';
import { DEFAULT_QUESTIONS } from './src/milestone/requirements.js';

// Simulate workflow progression
let state = createInitialState(1);

// Simulate run 1 - increment run count
state.workflow.runCount++;
state.workflow.lastRunAt = new Date().toISOString();

// Answer first required question
state.requirements.answered.push('scope');
state.requirements.pending = state.requirements.pending.filter(q => q !== 'scope');
state.workflow.lastCommentId = 100;

console.log('After run 1:', {
  runCount: state.workflow.runCount,
  answered: state.requirements.answered,
  pending: state.requirements.pending,
  lastCommentId: state.workflow.lastCommentId
});

// Simulate run 2
state.workflow.runCount++;
state.workflow.lastRunAt = new Date().toISOString();

// Answer second required question
state.requirements.answered.push('features');
state.requirements.pending = state.requirements.pending.filter(q => q !== 'features');
state.workflow.lastCommentId = 102;

console.log('After run 2:', {
  runCount: state.workflow.runCount,
  answered: state.requirements.answered,
  pending: state.requirements.pending,
  lastCommentId: state.workflow.lastCommentId
});

// Check if requirements complete
const complete = isRequirementsComplete(state, DEFAULT_QUESTIONS);
console.log('All required questions answered:', complete === true);

// Answer optional questions (should not affect completeness)
state.requirements.answered.push('constraints', 'timeline');
state.requirements.pending = [];

console.log('After all answered:', {
  complete: isRequirementsComplete(state, DEFAULT_QUESTIONS),
  answered: state.requirements.answered.length,
  pending: state.requirements.pending.length
});
"
</verify>
  <done>
State progression works correctly through multiple workflow runs, runCount increments, and isRequirementsComplete accurately determines completion status
</done>
</task>

</tasks>

<verification>
1. Module imports without errors in Node.js
2. createInitialState produces valid initial state structure
3. loadState returns initial state for new milestones (404 case)
4. saveState handles both create and update (with SHA)
5. isRequirementsComplete correctly checks required questions
6. State tracks lastCommentId for filtering new comments
</verification>

<success_criteria>
- src/milestone/state.js exports all required functions
- State persists across workflow runs via STATE.md
- Requirements gathering progress is correctly tracked
- Last comment ID is maintained for filtering new user responses
</success_criteria>

<output>
After completion, create `.planning/phases/05-milestone-creation-workflow/05-03-SUMMARY.md`
</output>
