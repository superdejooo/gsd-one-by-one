---
phase: 05-milestone-creation-workflow
plan: "04"
type: execute
wave: 2
depends_on:
  - 05-01
  - 05-02
  - 05-03
files_modified:
  - src/milestone/index.js
  - src/milestone/summarizer.js
  - src/index.js
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Milestone workflow orchestrates all modules (planning-docs, requirements, state)"
    - "Planning documents are committed to gsd/{n} branch"
    - "Summary comment is posted with created files and next steps"
  artifacts:
    - path: "src/milestone/index.js"
      provides: "Milestone workflow orchestrator"
      exports: ["executeMilestoneWorkflow", "parseMilestoneNumber"]
    - path: "src/milestone/summarizer.js"
      provides: "Summary comment generation"
      exports: ["generateMilestoneSummary"]
  key_links:
    - from: "src/milestone/index.js"
      to: "src/milestone/planning-docs.js"
      via: "createPlanningDocs call"
      pattern: "createPlanningDocs"
    - from: "src/milestone/index.js"
      to: "src/milestone/requirements.js"
      via: "getNewComments, parseUserAnswers, DEFAULT_QUESTIONS"
      pattern: "getNewComments.*parseUserAnswers"
    - from: "src/milestone/index.js"
      to: "src/milestone/state.js"
      via: "loadState, saveState"
      pattern: "loadState.*saveState"
    - from: "src/milestone/index.js"
      to: "src/git/branches.js"
      via: "createMilestoneBranch"
      pattern: "createMilestoneBranch"
    - from: "src/milestone/index.js"
      to: "src/lib/github.js"
      via: "postComment"
      pattern: "postComment.*getWorkflowRunUrl"
---

<objective>
Create the milestone workflow orchestrator that ties together planning docs, requirements gathering, state management, and git operations into a complete milestone creation workflow.

Purpose: Provide the complete milestone creation experience from requirements gathering through document creation and summary posting.
Output: src/milestone/index.js (orchestrator) and src/milestone/summarizer.js (summary generator)
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@/Users/dejan/00-code/00-ai-agents-skills-plugins/agent/.planning/phases/05-milestone-creation-workflow/05-RESEARCH.md
@/Users/dejan/00-code/00-ai-agents-skills-plugins/agent/src/index.js
</context>

<tasks>

<task type="auto">
  <name>Create src/milestone/summarizer.js module</name>
  <files>src/milestone/summarizer.js</files>
  <action>
Create the summary comment generator module:

1. Export generateMilestoneSummary(data):
   - Accepts data object with: milestoneNumber, files, requirements, nextSteps, status
   - Returns markdown formatted summary comment
   - Format includes:
     - Header with milestone number and status
     - Table of created files with purposes
     - Requirements status (complete or pending count)
     - Numbered next steps list
     - Branch reference
     - Footer with bot signature

2. The summary should match the format shown in Pattern 6 of 05-RESEARCH.md

3. Handle edge cases:
   - Empty files array
   - Empty nextSteps array
   - Partial requirements completion
     </action>
     <verify>
     node --input-type=module -e "
     import { generateMilestoneSummary } from './src/milestone/summarizer.js';

const testData = {
milestoneNumber: 1,
status: 'Requirements Gathering',
files: [
{ path: '.github/planning/milestones/1/PROJECT.md', purpose: 'Milestone context and goals' },
{ path: '.github/planning/milestones/1/STATE.md', purpose: 'Milestone status tracking' },
{ path: '.github/planning/milestones/1/ROADMAP.md', purpose: 'Phase structure' }
],
requirements: {
complete: false,
answered: ['scope'],
pending: ['features', 'constraints']
},
nextSteps: [
'Answer remaining requirements questions',
'Review planning documents',
'Use @gsd-bot plan-phase to plan each phase'
]
};

const summary = generateMilestoneSummary(testData);
console.log('Summary generated:', summary.length > 0);
console.log('Includes milestone number:', summary.includes('Milestone 1'));
console.log('Includes files table:', summary.includes('Files Created'));
console.log('Includes next steps:', summary.includes('Next Steps'));
console.log('Includes branch info:', summary.includes('gsd/1'));
"
</verify>
<done>
src/milestone/summarizer.js exists with generateMilestoneSummary working correctly, and test output confirms all expected sections are present
</done>
</task>

<task type="auto">
  <name>Create src/milestone/index.js orchestrator</name>
  <files>src/milestone/index.js</files>
  <action>
Create the milestone workflow orchestrator with the following structure:

1. Import all required modules:
   - - as core from "@actions/core"
   - - as github from "@actions/github"
   - { postComment, getWorkflowRunUrl } from "../lib/github.js"
   - { formatErrorComment } from "../errors/formatter.js"
   - { createMilestoneBranch } from "../git/branches.js"
   - { runGitCommand, configureGitIdentity } from "../git/git.js"
   - { loadState, saveState, createInitialState } from "./state.js"
   - { createPlanningDocs } from "./planning-docs.js"
   - { getNewComments, parseUserAnswers, formatRequirementsQuestions, parseAnswersFromResponse, DEFAULT_QUESTIONS } from "./requirements.js"
   - { generateMilestoneSummary } from "./summarizer.js"

2. Export parseMilestoneNumber(commandArgs):
   - Extract milestone number from command args
   - Return parsed number or throw error

3. Export executeMilestoneWorkflow(context, commandArgs):
   - Parse milestone number from args
   - Load state or create initial state
   - Increment run count and update lastRunAt
   - Get new comments since last processed (getNewComments)
   - Parse user answers from new comments (parseUserAnswers)
   - Merge answers into state (parseAnswersFromResponse)
   - Update state with new answers
   - Check if requirements complete (all required answered)
   - If incomplete:
     - Format and post pending questions (formatRequirementsQuestions)
     - Save state
     - Return { complete: false, phase: "requirements-gathering" }
   - If complete:
     - Create planning documents (createPlanningDocs)
     - Create milestone branch (createMilestoneBranch)
     - Commit all files via git
     - Save state with complete status
     - Generate and post summary comment
     - Return { complete: true, files: [...] }

4. Helper function commitPlanningDocs(filePaths, milestoneNumber):
   - Configure git identity
   - Stage all files
   - Commit with appropriate message
     </action>
     <verify>
     node --input-type=module -e "
     import { executeMilestoneWorkflow, parseMilestoneNumber } from './src/milestone/index.js';

console.log('All exports available:', {
executeMilestoneWorkflow: typeof executeMilestoneWorkflow === 'function',
parseMilestoneNumber: typeof parseMilestoneNumber === 'function'
});

// Test parseMilestoneNumber
const testArgs = 'new-milestone --milestone 5';
const num = parseMilestoneNumber(testArgs);
console.log('Parsed milestone 5:', num === 5);

// Test with just number
const num2 = parseMilestoneNumber('7');
console.log('Parsed milestone 7:', num2 === 7);
"
</verify>
<done>
src/milestone/index.js exists with executeMilestoneWorkflow and parseMilestoneNumber exports, and parseMilestoneNumber correctly extracts milestone numbers
</done>
</task>

<task type="auto">
  <name>Integrate milestone workflow into main entry point</name>
  <files>src/index.js</files>
  <action>
Update src/index.js to integrate the milestone workflow:

1. Add imports for milestone workflow:

   ```javascript
   import {
     executeMilestoneWorkflow,
     parseMilestoneNumber,
   } from "./milestone/index.js";
   ```

2. Update the command handling in the try block:
   - After validateCommand and sanitizeArguments
   - Add command dispatch based on parsed.command:
     ```javascript
     if (parsed.command === "new-milestone") {
       const result = await executeMilestoneWorkflow(
         { owner: repoOwner, repo: repoName, issueNumber },
         sanitizedArgs,
       );
       core.info(`Milestone workflow result: ${JSON.stringify(result)}`);
     }
     ```

3. Update outputs to include milestone workflow results

4. Trigger bundling of milestone modules:
   ```javascript
   const _milestoneModule = { executeMilestoneWorkflow, parseMilestoneNumber };
   ```
   </action>
     <verify>
   node --input-type=module -e "
   // Verify index.js can be parsed without syntax errors
   import fs from 'node:fs';
   const content = fs.readFileSync('./src/index.js', 'utf-8');
   console.log('index.js is valid JavaScript:', content.includes('executeMilestoneWorkflow') && content.includes('parseMilestoneNumber'));
   console.log('Module trigger added:', content.includes('_milestoneModule'));
   "
   </verify>
     <done>
   src/index.js imports and triggers the milestone workflow module, command dispatch handles "new-milestone" command by calling executeMilestoneWorkflow
   </done>
   </task>

</tasks>

<verification>
1. summarizer.js generates properly formatted summary comments
2. orchestrator module exports executeMilestoneWorkflow and parseMilestoneNumber
3. parseMilestoneNumber correctly extracts milestone number from arguments
4. index.js imports milestone workflow modules
5. Command dispatch routes "new-milestone" to executeMilestoneWorkflow
</verification>

<success_criteria>

- src/milestone/summarizer.js generates completion summary comments
- src/milestone/index.js orchestrates complete milestone creation workflow
- src/index.js integrates milestone command handling
- Workflow creates planning docs, commits to branch, posts summary
  </success_criteria>

<output>
After completion, create `.planning/phases/05-milestone-creation-workflow/05-04-SUMMARY.md`
</output>
