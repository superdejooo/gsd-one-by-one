# Plan 11-01: Output Parsing and Error Handling Improvements

## Goal

Fix output formatting issues in GitHub comments posted by execute-phase command, including duplicate error comments and CCR debug log pollution.

## Context

When executing phases via GitHub Actions, the bot comments were showing:

1. Duplicate error comments (posted by both workflow catch block AND withErrorHandling wrapper)
2. CCR debug logs polluting the output ([log_xxx], response 200 http://..., JS object notation)
3. False positive "completed" task matching from markdown tables containing "Complete"

## Tasks

### Task 1: Fix Duplicate Error Comments

**Files:** `src/milestone/phase-planner.js`, `src/milestone/phase-executor.js`

**Changes:**

- Remove `postComment` calls from catch blocks in workflow modules
- Remove unused imports (`formatErrorComment`, `getWorkflowRunUrl`)
- Delegate all error comment posting to `withErrorHandling` wrapper

**Verification:** Only one error comment appears per failure

### Task 2: Fix Completed Task Parsing

**Files:** `src/milestone/phase-executor.js`

**Changes:**

- Replace greedy regex `/(?:\[x\]|completed?:?|done:?)/gi` with strict checkbox-only pattern
- Only match explicit `[x]` markers at line start
- Avoid matching "✓ Complete" from markdown tables

**Verification:** Parsing `output.txt` with markdown tables doesn't produce false positives

### Task 3: Extract GSD Block from Output

**Files:** `src/milestone/phase-executor.js`

**Changes:**

- Add `extractGsdBlock()` function to find last "GSD ►" marker
- Include line above (box drawing) and everything after
- Fall back to last 80 lines if no GSD marker found

**Verification:** GSD status messages display cleanly with box drawing characters

### Task 4: Strip CCR Debug Logs

**Files:** `src/milestone/phase-executor.js`

**Changes:**

- Add `stripCcrLogs()` function to filter out CCR logging patterns:
  - `[log_xxx]` prefixes
  - `response 200 http://...` lines
  - `ReadableStream`, `AbortController`, `AsyncGeneratorFunction`
  - JS object key: value patterns
  - Closing braces and object bodies

**Verification:** Output contains only GSD response, no CCR logging

### Task 5: Update Tests

**Files:** `src/milestone/phase-executor.test.js`, `src/milestone/phase-planner.test.js`

**Changes:**

- Update error handling tests (no longer expect postComment in catch blocks)
- Add tests for CCR log stripping
- Add tests for GSD block extraction (last marker, fallback)
- Remove unused mock imports

**Verification:** All 353 tests pass with 79%+ branch coverage

## Dependencies

- None (internal improvements to existing modules)

## Success Criteria

1. Single error comment per failure (not duplicates)
2. GitHub comments show clean GSD output without CCR logs
3. No false positive "completed" matches from markdown tables
4. All tests pass with coverage thresholds met
