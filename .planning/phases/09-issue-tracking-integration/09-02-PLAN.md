---
phase: "09-issue-tracking-integration"
plan: "02"
type: "execute"
wave: 2
depends_on: ["09-01"]
files_modified:
  - "src/milestone/phase-planner.js"
autonomous: true
must_haves:
  truths:
    - "Phase planner creates GitHub issues after GSD planning completes"
    - "Issues are created for each task in the PLAN.md file(s)"
    - "Planning result comment includes links to created issues"
  artifacts:
    - path: "src/milestone/phase-planner.js"
      provides: "Issue creation integrated into executePhaseWorkflow"
  key_links:
    - from: "src/milestone/phase-planner.js"
      to: "src/lib/issues.js"
      via: "import { extractTasksFromPlan, createIssuesForTasks }"
    - from: "src/milestone/phase-planner.js"
      to: "fs/promises"
      via: "Read PLAN.md files after GSD completes"
---

<objective>
Integrate issue creation into the phase planner workflow.

Purpose: After GSD creates PLAN.md files, the phase planner should parse them and create corresponding GitHub issues for tracking.

Output: Modified phase-planner.js that creates issues after successful planning.
</objective>

<context>
@src/milestone/phase-planner.js
@src/lib/issues.js
@.planning/phases/09-issue-tracking-integration/09-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add PLAN.md reading to phase-planner.js</name>
  <files>src/milestone/phase-planner.js</files>
  <action>
    Modify src/milestone/phase-planner.js to read PLAN.md files after GSD planning completes.

    **Add imports at top:**
    ```javascript
    import path from "path";
    import { extractTasksFromPlan, createIssuesForTasks } from "../lib/issues.js";
    ```

    **Add helper function findPlanFiles(phaseNumber):**
    ```javascript
    /**
     * Find all PLAN.md files for a phase
     * @param {number} phaseNumber - Phase number
     * @returns {Promise<Array<{path: string, filename: string, phaseDir: string}>>}
     */
    async function findPlanFiles(phaseNumber) {
      const paddedPhase = String(phaseNumber).padStart(2, '0');
      const phasesDir = '.planning/phases';

      // Find phase directory (handles 01-name and 1-name patterns)
      const dirs = await fs.readdir(phasesDir);
      const phaseDir = dirs.find(d =>
        d.startsWith(`${paddedPhase}-`) || d.startsWith(`${phaseNumber}-`)
      );

      if (!phaseDir) {
        core.warning(`Phase directory not found for phase ${phaseNumber}`);
        return [];
      }

      // Find all PLAN.md files
      const files = await fs.readdir(path.join(phasesDir, phaseDir));
      const planFiles = files.filter(f => f.endsWith('-PLAN.md'));

      return planFiles.map(filename => ({
        path: path.join(phasesDir, phaseDir, filename),
        filename,
        phaseDir
      }));
    }
    ```

    **Add helper function extractPhaseName(phaseDir):**
    ```javascript
    /**
     * Extract human-readable phase name from directory
     * @param {string} phaseDir - e.g., "09-issue-tracking-integration"
     * @returns {string} - e.g., "Issue Tracking Integration"
     */
    function extractPhaseName(phaseDir) {
      const parts = phaseDir.split('-');
      parts.shift(); // Remove number prefix
      return parts
        .map(word => word.charAt(0).toUpperCase() + word.slice(1))
        .join(' ');
    }
    ```

  </action>
  <verify>grep -q "findPlanFiles" src/milestone/phase-planner.js && grep -q "extractPhaseName" src/milestone/phase-planner.js</verify>
  <done>Helper functions for reading PLAN.md files exist</done>
</task>

<task type="auto">
  <name>Task 2: Integrate issue creation into executePhaseWorkflow</name>
  <files>src/milestone/phase-planner.js</files>
  <action>
    Modify executePhaseWorkflow in src/milestone/phase-planner.js to create issues after successful planning.

    **After the success output is posted (after line ~122), add issue creation:**

    Insert before the cleanup section:
    ```javascript
    // Step 6: Create GitHub issues for tasks
    let createdIssues = [];
    try {
      const planFiles = await findPlanFiles(phaseNumber);

      if (planFiles.length === 0) {
        core.warning('No PLAN.md files found, skipping issue creation');
      } else {
        const phaseName = extractPhaseName(planFiles[0].phaseDir);

        for (const planFile of planFiles) {
          core.info(`Processing ${planFile.filename}`);
          const planContent = await fs.readFile(planFile.path, 'utf-8');
          const tasks = extractTasksFromPlan(planContent);

          if (tasks.length > 0) {
            const issues = await createIssuesForTasks(
              owner, repo, tasks, phaseNumber, phaseName
            );
            createdIssues.push(...issues);
          }
        }

        // Post follow-up comment with issue links
        if (createdIssues.length > 0) {
          const issueList = createdIssues
            .map(i => `- [ ] #${i.number} - ${i.taskName}`)
            .join('\n');

          await postComment(owner, repo, issueNumber,
            `## Issues Created\n\n${issueList}\n\n*Track progress by checking off completed issues.*`
          );
        }
      }
    } catch (issueError) {
      core.warning(`Issue creation failed: ${issueError.message}`);
      // Don't fail the workflow - planning succeeded, issues are supplementary
    }
    ```

    **Update return statement to include issue count:**
    ```javascript
    return {
      complete: true,
      phaseNumber,
      issuesCreated: createdIssues.length,
      message: "Phase planning completed successfully"
    };
    ```

  </action>
  <verify>grep -q "createIssuesForTasks" src/milestone/phase-planner.js && grep -q "issuesCreated" src/milestone/phase-planner.js</verify>
  <done>executePhaseWorkflow creates issues after successful planning</done>
</task>

</tasks>

<verification>
1. Module loads: `node -e "import('./src/milestone/phase-planner.js')"`
2. Imports issues.js functions
3. findPlanFiles finds PLAN.md in phase directory
4. extractPhaseName converts "09-issue-tracking-integration" to "Issue Tracking Integration"
5. Issues created after GSD output posted
6. Failure in issue creation does not fail the workflow
</verification>

<success_criteria>

- [ ] phase-planner.js imports from issues.js
- [ ] findPlanFiles helper finds PLAN.md files for a phase
- [ ] extractPhaseName helper converts directory to title case
- [ ] executePhaseWorkflow creates issues after successful planning
- [ ] Issue creation failure is logged but does not fail workflow
- [ ] Follow-up comment lists created issues with checkboxes
- [ ] Return value includes issuesCreated count
      </success_criteria>

<output>
After completion, create `.planning/phases/09-issue-tracking-integration/09-02-SUMMARY.md`
</output>
