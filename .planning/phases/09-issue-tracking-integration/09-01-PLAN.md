---
phase: "09-issue-tracking-integration"
plan: "01"
type: "execute"
wave: 1
depends_on: []
files_modified:
  - "src/lib/issues.js"
autonomous: true
must_haves:
  truths:
    - "PLAN.md task blocks can be parsed into structured objects"
    - "GitHub issues can be created from parsed tasks"
    - "Issues have correct labels (phase-N, status:pending)"
    - "Phase issues can be queried by phase label"
  artifacts:
    - path: "src/lib/issues.js"
      provides: "extractTasksFromPlan, createIssuesForTasks, getPhaseIssues, formatIssueBody"
      exports:
        [
          "extractTasksFromPlan",
          "createIssuesForTasks",
          "getPhaseIssues",
          "formatIssueBody",
        ]
  key_links:
    - from: "src/lib/issues.js"
      to: "src/lib/github.js"
      via: "import { octokit }"
    - from: "src/lib/issues.js"
      to: "src/lib/labels.js"
      via: "import { ensureLabelsExist, STATUS_LABELS }"
---

<objective>
Create the issues.js module that parses PLAN.md files and creates GitHub issues.

Purpose: Provide reusable functions for extracting tasks from GSD plans and creating corresponding GitHub issues with proper labels and formatting.

Output: src/lib/issues.js with 4 exported functions for the phase planner and executor to use.
</objective>

<context>
@src/lib/github.js
@src/lib/labels.js
@.planning/phases/09-issue-tracking-integration/09-RESEARCH.md
@.planning/phases/07-phase-planning-command/07-01-PLAN.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create issues.js with task parsing</name>
  <files>src/lib/issues.js</files>
  <action>
    Create src/lib/issues.js with the following functions:

    **Imports:**
    ```javascript
    import * as core from "@actions/core";
    import { octokit } from "./github.js";
    import { ensureLabelsExist, STATUS_LABELS } from "./labels.js";
    ```

    **extractTasksFromPlan(planContent):**
    - Parse PLAN.md content using regex to extract task blocks
    - Match XML-style task tags: `<task type="auto">...</task>`
    - Extract: type, name, files, action, verify, done
    - Handle multiline content in each field
    - Return array of task objects

    Pattern to match (from 09-RESEARCH.md):
    ```javascript
    const taskPattern = /<task\s+type="(auto|checkpoint:[^"]+)">\s*<name>([\s\S]*?)<\/name>\s*<files>([\s\S]*?)<\/files>\s*<action>([\s\S]*?)<\/action>\s*<verify>([\s\S]*?)<\/verify>\s*<done>([\s\S]*?)<\/done>\s*<\/task>/g;
    ```

    Clean extracted content:
    - Trim whitespace
    - Remove leading "Task N:" prefix from name field
    - Preserve newlines in action/verify/done fields

    **formatIssueBody(task, phaseNumber, phaseName):**
    - Create markdown body with task details
    - Include: Phase context, Files, Type, Action, Verification, Done criteria
    - Add "Created by GSD Phase Planner" footer
    - Truncate body if exceeds 65000 chars (GitHub limit is 65536)

    Template:
    ```markdown
    ## Task Details

    **Phase:** {phaseNumber} - {phaseName}
    **Files:** {task.files}
    **Type:** {task.type}

    ## Action

    {task.action}

    ## Verification

    ```bash
    {task.verify}
    ```

    ## Done Criteria

    {task.done}

    ---
    *Created by GSD Phase Planner*
    ```

  </action>
  <verify>node -e "import('./src/lib/issues.js').then(m => console.log('extractTasksFromPlan:', typeof m.extractTasksFromPlan, 'formatIssueBody:', typeof m.formatIssueBody))"</verify>
  <done>extractTasksFromPlan and formatIssueBody functions exist and export correctly</done>
</task>

<task type="auto">
  <name>Task 2: Add issue creation and query functions</name>
  <files>src/lib/issues.js</files>
  <action>
    Add to src/lib/issues.js:

    **createIssuesForTasks(owner, repo, tasks, phaseNumber, phaseName):**
    - Ensure phase label exists (e.g., "phase-9")
    - Ensure status labels exist (call ensureLabelsExist once)
    - Create issues sequentially (rate limiting handled by octokit plugin)
    - Issue title format: "09: Task Name" (padded phase number + cleaned name)
    - Title max 240 chars (truncate with "..." if needed)
    - Labels: ["status:pending", `phase-${phaseNumber}`]
    - Return array of created issue metadata: { number, url, taskName }
    - Log progress with core.info
    - Continue on single issue failure, log warning

    Phase label creation:
    ```javascript
    const phaseLabel = {
      name: `phase-${phaseNumber}`,
      color: '1d76db',  // Blue
      description: `Phase ${phaseNumber} tasks`
    };
    await ensureLabelsExist(owner, repo, [phaseLabel, ...STATUS_LABELS]);
    ```

    Issue creation:
    ```javascript
    const issue = await octokit.rest.issues.create({
      owner,
      repo,
      title: truncateTitle(`${String(phaseNumber).padStart(2, '0')}: ${cleanTaskName}`, 240),
      body: formatIssueBody(task, phaseNumber, phaseName),
      labels: ['status:pending', `phase-${phaseNumber}`]
    });
    ```

    **getPhaseIssues(owner, repo, phaseNumber):**
    - Query issues by phase label
    - Return array: { number, title, status, url }
    - Status extracted from status: label prefix
    - Handle pagination (up to 100 issues per phase is sufficient)

    Query:
    ```javascript
    const { data: issues } = await octokit.rest.issues.listForRepo({
      owner,
      repo,
      labels: `phase-${phaseNumber}`,
      state: 'all',
      per_page: 100
    });
    ```

    **Helper: truncateTitle(title, maxLength):**
    - Truncate at maxLength-3, append "..."
    - Return original if under limit

  </action>
  <verify>node -e "import('./src/lib/issues.js').then(m => console.log('createIssuesForTasks:', typeof m.createIssuesForTasks, 'getPhaseIssues:', typeof m.getPhaseIssues))"</verify>
  <done>createIssuesForTasks and getPhaseIssues functions exist and export correctly</done>
</task>

</tasks>

<verification>
1. Module loads: `node -e "import('./src/lib/issues.js')"`
2. Exports exist: extractTasksFromPlan, createIssuesForTasks, getPhaseIssues, formatIssueBody
3. Task parsing works on sample PLAN.md content
4. Issue body format matches template
</verification>

<success_criteria>

- [ ] src/lib/issues.js exists with 4 exported functions
- [ ] extractTasksFromPlan parses XML-style task blocks
- [ ] formatIssueBody creates markdown with task details
- [ ] createIssuesForTasks creates issues with correct labels
- [ ] getPhaseIssues queries issues by phase label
- [ ] Title truncation prevents API errors (240 char limit)
- [ ] Body truncation prevents API errors (65000 char limit)
      </success_criteria>

<output>
After completion, create `.planning/phases/09-issue-tracking-integration/09-01-SUMMARY.md`
</output>
